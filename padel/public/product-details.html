<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles del Producto - P√°del Fuego</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* ESTILOS ESPEC√çFICOS PARA DETALLES DEL PRODUCTO */
        
        /* Back Navigation */
        .back-navigation {
            padding: 20px 5%;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #2c5530;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            background: #e8f0e8;
        }
        
        /* Product Details Container */
        .product-details-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 5%;
        }
        
        .product-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            margin-bottom: 50px;
        }
        
        @media (max-width: 992px) {
            .product-details-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
        
        /* Product Images */
        .product-images {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .main-image-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .main-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            cursor: zoom-in;
            transition: transform 0.5s;
        }
        
        .main-image:hover {
            transform: scale(1.02);
        }
        
        .image-zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .zoomed-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .close-zoom {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .thumbnail-images {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .thumbnail:hover {
            border-color: #2c5530;
        }
        
        .thumbnail.active {
            border-color: #2c5530;
            transform: scale(1.05);
        }
        
        /* Product Info */
        .product-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .product-header {
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 20px;
        }
        
        .product-title {
            font-size: 2.5rem;
            color: #2c5530;
            margin-bottom: 10px;
        }
        
        .product-brand {
            font-size: 1.2rem;
            color: #666;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .product-rating {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .rating-stars {
            color: #ffd700;
            font-size: 1.2rem;
        }
        
        .rating-value {
            font-weight: bold;
            color: #333;
        }
        
        .reviews-count {
            color: #666;
        }
        
        .product-price-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e8f0e8;
        }
        
        .price-main {
            font-size: 2.8rem;
            font-weight: bold;
            color: #2c5530;
            margin-bottom: 10px;
        }
        
        .price-old {
            font-size: 1.5rem;
            color: #999;
            text-decoration: line-through;
            margin-right: 10px;
        }
        
        .discount-badge {
            background: #ff6b35;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        .stock-status {
            font-size: 1.1rem;
            font-weight: bold;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .in-stock {
            color: #2c5530;
        }
        
        .low-stock {
            color: #ff9800;
        }
        
        .out-of-stock {
            color: #ff4444;
        }
        
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .quantity-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #2c5530;
            background: white;
            color: #2c5530;
            font-size: 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background: #2c5530;
            color: white;
        }
        
        .quantity-btn:disabled {
            border-color: #ccc;
            color: #ccc;
            cursor: not-allowed;
        }
        
        .quantity-btn:disabled:hover {
            background: white;
            color: #ccc;
        }
        
        .quantity-input {
            width: 60px;
            height: 40px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        .btn-add-cart {
            flex: 2;
            background: #2c5530;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-add-cart:hover {
            background: #1e3a23;
            transform: translateY(-2px);
        }
        
        .btn-add-cart:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-wishlist {
            flex: 1;
            background: white;
            color: #2c5530;
            border: 2px solid #2c5530;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-wishlist:hover {
            background: #2c5530;
            color: white;
        }
        
        .product-meta {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }
        
        /* Product Tabs */
        .product-tabs {
            margin-top: 40px;
        }
        
        .tabs-header {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 30px;
        }
        
        .tab-btn {
            padding: 15px 30px;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            color: #2c5530;
        }
        
        .tab-btn.active {
            color: #2c5530;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #2c5530;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .description-content {
            line-height: 1.8;
            font-size: 1.1rem;
            color: #333;
        }
        
        .specs-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .specs-table tr {
            border-bottom: 1px solid #eee;
        }
        
        .specs-table td {
            padding: 12px 0;
        }
        
        .specs-table td:first-child {
            font-weight: 600;
            color: #555;
            width: 30%;
        }
        
        .reviews-container {
            max-width: 800px;
        }
        
        .review-form {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .review-form h4 {
            margin-bottom: 15px;
            color: #2c5530;
        }
        
        .rating-input {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .rating-input input {
            display: none;
        }
        
        .rating-input label {
            font-size: 2rem;
            color: #ddd;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .rating-input input:checked ~ label,
        .rating-input label:hover,
        .rating-input label:hover ~ label {
            color: #ffd700;
        }
        
        .review-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .review-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #eee;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .review-author {
            font-weight: 600;
            color: #333;
        }
        
        .review-date {
            color: #999;
            font-size: 0.9rem;
        }
        
        .review-rating {
            color: #ffd700;
            margin: 5px 0;
        }
        
        /* Related Products */
        .related-products {
            margin-top: 60px;
            padding-top: 40px;
            border-top: 2px solid #eee;
        }
        
        .related-products h3 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
            color: #2c5530;
        }
        
        .related-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .product-title {
                font-size: 2rem;
            }
            
            .price-main {
                font-size: 2.2rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .tabs-header {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .main-image {
                height: 300px;
            }
        }
        
        @media (max-width: 480px) {
            .product-details-container {
                padding: 20px;
            }
            
            .product-title {
                font-size: 1.8rem;
            }
            
            .price-main {
                font-size: 1.8rem;
            }
            
            .quantity-selector {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        /* Breadcrumb */
        .breadcrumb {
            padding: 15px 5%;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9rem;
        }
        
        .breadcrumb a {
            color: #2c5530;
            text-decoration: none;
        }
        
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        
        .breadcrumb span {
            color: #666;
            margin: 0 5px;
        }

        /* ESTILOS DEL CARRITO */
        .cart-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: flex-end;
            align-items: flex-start;
            padding-top: 80px;
        }
        
        .cart-modal-content {
            background: white;
            width: 100%;
            max-width: 400px;
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.1);
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #2c5530;
            color: white;
        }
        
        .cart-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }
        
        .close-cart {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cart-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .cart-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .cart-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .cart-item-info h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 1rem;
        }
        
        .cart-item-price {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .cart-item-controls {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cart-item-controls button {
            background: #2c5530;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cart-item-controls button:hover {
            background: #1e3a23;
        }
        
        .cart-item-controls .remove-btn {
            background: #ff4444;
            margin-left: auto;
        }
        
        .cart-item-controls .remove-btn:hover {
            background: #cc0000;
        }
        
        .cart-item-quantity {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
        }
        
        .cart-item-subtotal {
            grid-column: 1 / -1;
            text-align: right;
            font-weight: bold;
            color: #2c5530;
            font-size: 1.1rem;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        
        .empty-cart {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .cart-footer {
            border-top: 2px solid #2c5530;
            padding: 20px;
            background: #f9f9f9;
        }
        
        .cart-summary {
            margin-bottom: 20px;
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c5530;
        }
        
        .cart-actions {
            display: flex;
            gap: 10px;
        }
        
        .cart-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-clear {
            background: #ff4444;
            color: white;
        }
        
        .btn-clear:hover {
            background: #cc0000;
        }
        
        .btn-checkout {
            background: #ff6b35;
            color: white;
        }
        
        .btn-checkout:hover {
            background: #e55a2b;
        }
        
        .cart-counter {
            background: #ff6b35;
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 0.8rem;
            margin-left: 5px;
            display: inline-block;
            min-width: 20px;
            text-align: center;
        }
        
        .cart-link {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .cart-modal-content {
                width: 100%;
                max-width: 100%;
            }
            
            .cart-item {
                grid-template-columns: 1fr;
            }
            
            .cart-actions {
                flex-direction: column;
            }
            
            .cart-actions button {
                width: 100%;
            }
        }

    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <h1>P√°del Fuego</h1>
            </div>
            <ul class="nav-links">
                <li><a href="/">Inicio</a></li>
                <li><a href="/#productos">Productos</a></li>
                <li><a href="/#nosotros">Nosotros</a></li>
                <li><a href="/#contacto">Contacto</a></li>
                
                <li><a href="#" class="cart-link" onclick="toggleCart(); return false;">üõí Carrito <span id="cart-counter" class="cart-counter">0</span></a></li>
            </ul>
        </nav>
    </header>

    <!-- Breadcrumb -->
    <div class="breadcrumb" id="breadcrumb">
        <a href="/">Inicio</a> <span>></span>
        <a href="/#productos">Productos</a> <span>></span>
        <span id="current-product">Cargando...</span>
    </div>

    <!-- Back Navigation -->
    <div class="back-navigation">
        <a href="/" class="back-link">
            ‚Üê Volver a todos los productos
        </a>
    </div>

    <!-- Product Details Container -->
    <div class="product-details-container">
        <div id="loading" class="loading" style="display: none;">
            Cargando detalles del producto...
        </div>
        
        <div id="error-message" style="display: none; background: #f8d7da; color: #721c24; padding: 20px; border-radius: 8px; text-align: center;">
            Error cargando el producto. Por favor, intenta nuevamente.
        </div>
        
        <div id="product-content" style="display: none;">
            <!-- Product Images Section -->
            <div class="product-images">
                <div class="main-image-container">
                    <img id="main-product-image" class="main-image" src="" alt="">
                </div>
                <div class="thumbnail-images" id="thumbnail-images">
                    <!-- Thumbnails will be added dynamically -->
                </div>
            </div>

            <!-- Product Info Section -->
            <div class="product-info">
                <div class="product-header">
                    <h1 class="product-title" id="product-title">Cargando...</h1>
                    <div class="product-brand" id="product-brand"></div>
                    
                    <div class="product-rating">
                        <div class="rating-stars" id="rating-stars"></div>
                        <span class="rating-value" id="rating-value"></span>
                        <span class="reviews-count" id="reviews-count">(0 rese√±as)</span>
                    </div>
                </div>
                
                <div class="product-price-section">
                    <div class="price-main" id="product-price">$0</div>
                    <div id="discount-container" style="display: none;">
                        <span class="price-old" id="old-price">$0</span>
                        <span class="discount-badge" id="discount-badge">0% OFF</span>
                    </div>
                    
                    <div class="stock-status">
                        Estado: <span id="stock-status" class="in-stock">Cargando...</span>
                    </div>
                    
                    <div class="description-content" id="short-description"></div>
                </div>
                
                <!-- Quantity Selector -->
                <div class="quantity-selector">
                    <label for="quantity">Cantidad:</label>
                    <button class="quantity-btn" id="decrease-qty" disabled>-</button>
                    <input type="number" id="quantity" class="quantity-input" value="1" min="1" max="10">
                    <button class="quantity-btn" id="increase-qty">+</button>
                    <span style="color: #666; margin-left: 10px;">M√°x: <span id="max-quantity">10</span> unidades</span>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn-add-cart" id="add-to-cart-btn">
                        üõí Agregar al Carrito
                    </button>
                    <button class="btn-wishlist" id="wishlist-btn">
                        ‚ô• Agregar a Favoritos
                    </button>
                </div>
                
                <!-- Product Meta -->
                <div class="product-meta">
                    <div class="meta-item">
                        üì¶ <span>Env√≠o gratis en compras +$50,000</span>
                    </div>
                    <div class="meta-item">
                        üîÑ <span>30 d√≠as de garant√≠a</span>
                    </div>
                    <div class="meta-item">
                        üìû <span>Soporte 24/7</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Product Tabs -->
        <div class="product-tabs" id="product-tabs" style="display: none;">
            <div class="tabs-header">
                <button class="tab-btn active" data-tab="description">Descripci√≥n</button>
                <button class="tab-btn" data-tab="specifications">Especificaciones</button>
                <button class="tab-btn" data-tab="reviews">Rese√±as</button>
                <button class="tab-btn" data-tab="shipping">Env√≠o y Devoluciones</button>
            </div>
            
            <!-- Description Tab -->
            <div class="tab-content active" id="description-content">
                <div class="description-content" id="full-description"></div>
            </div>
            
            <!-- Specifications Tab -->
            <div class="tab-content" id="specifications-content">
                <table class="specs-table" id="specs-table">
                    <!-- Specifications will be loaded dynamically -->
                </table>
            </div>
            
            <!-- Reviews Tab -->
            <div class="tab-content" id="reviews-content">
                <div class="reviews-container">
                    <!-- Review form will be added here -->
                    <div class="review-list" id="review-list">
                        <!-- Reviews will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Shipping Tab -->
            <div class="tab-content" id="shipping-content">
                <div class="description-content">
                    <h3>üöö Pol√≠tica de Env√≠o</h3>
                    <p>‚Ä¢ Env√≠o est√°ndar: 3-5 d√≠as h√°biles</p>
                    <p>‚Ä¢ Env√≠o express disponible: 1-2 d√≠as h√°biles</p>
                    <p>‚Ä¢ Env√≠o gratis en compras mayores a $50,000</p>
                    <p>‚Ä¢ Realizamos env√≠os a todo el pa√≠s</p>
                    
                    <h3 style="margin-top: 30px;">üîÑ Pol√≠tica de Devoluciones</h3>
                    <p>‚Ä¢ 30 d√≠as de garant√≠a en todas las palas</p>
                    <p>‚Ä¢ El producto debe estar en empaque original</p>
                    <p>‚Ä¢ Costos de env√≠o de devoluci√≥n a cargo del cliente</p>
                    <p>‚Ä¢ Reembolso procesado en 5-7 d√≠as h√°biles</p>
                </div>
            </div>
        </div>
        
        <!-- Related Products -->
        <div class="related-products" id="related-products" style="display: none;">
            <h3>Productos Relacionados</h3>
            <div class="related-grid" id="related-grid">
                <!-- Related products will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Image Zoom Overlay -->
    <div class="image-zoom-overlay" id="image-zoom-overlay">
        <button class="close-zoom" id="close-zoom">√ó</button>
        <img class="zoomed-image" id="zoomed-image" src="" alt="">
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 P√°del Fuego. Todos los derechos reservados.</p>
    </footer>


 <!-- MODAL DEL CARRITO - A√ëADE ESTO -->
    <div id="cart-modal" class="cart-modal" style="display: none;">
        <div class="cart-modal-content">
            <div class="cart-header">
                <h3>üõí Tu Carrito</h3>
                <button class="close-cart" onclick="toggleCart()">√ó</button>
            </div>
            
            <div class="cart-body">
                <div id="cart-items" class="cart-items">
                    <!-- Productos se cargan aqu√≠ -->
                </div>
            </div>
            
            <div class="cart-footer">
                <div class="cart-summary">
                    <div class="cart-total">
                        <span>Total:</span>
                        <span id="cart-total">$0</span>
                    </div>
                </div>
                
                <div class="cart-actions">
                    <button class="btn-clear" onclick="clearCart()">
                        üóëÔ∏è Vaciar Carrito
                    </button>
                    <button class="btn-checkout" onclick="checkout()">
                        üí≥ Finalizar Compra
                    </button>
                </div>
            </div>
        </div>
    </div>

        <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <script>
        // ============================================
        // VARIABLES GLOBALES MEJORADAS
        // ============================================
        let currentProduct = null;
        let currentImages = [];
        let relatedProducts = [];
        let db = null;
        let hasLoaded = false;
        let cart = [];
        let cartOpen = false;

        // ============================================
        // FUNCIONES DE UTILIDAD
        // ============================================

        // Obtener ID del producto desde la URL con validaci√≥n
        function getProductIdFromURL() {
            try {
                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                
                if (!id || id.trim() === '' || id.length < 3) {
                    console.error('ID de producto inv√°lido:', id);
                    return null;
                }
                
                return id.trim();
            } catch (error) {
                console.error('Error obteniendo ID de la URL:', error);
                return null;
            }
        }

        // Funci√≥n para verificar la conexi√≥n a Firebase
        async function testFirebaseConnection() {
            console.log('üîç Verificando conexi√≥n a Firebase...');
            
            if (!window.db) {
                console.error('‚ùå window.db no est√° definido');
                return false;
            }
            
            try {
                const testQuery = await window.db.collection('products').limit(1).get();
                console.log('‚úÖ Conexi√≥n a Firestore OK. Total productos:', testQuery.size);
                return true;
            } catch (error) {
                console.error('‚ùå Error de conexi√≥n a Firestore:', error);
                console.error('Detalles del error:', error.code, error.message);
                return false;
            }
        }

        // Funci√≥n para mostrar error simple
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        // Funci√≥n mejorada para mostrar error con opciones
        function showErrorWithOptions(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            
            const errorElement = document.getElementById('error-message');
            errorElement.innerHTML = `
                <div style="text-align: center;">
                    <h3 style="color: #721c24; margin-bottom: 15px;">${message}</h3>
                    <p style="margin-bottom: 20px;">Puedes:</p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="window.location.href='/'" 
                                style="padding: 10px 20px; background: #2c5530; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ‚Üê Volver a la Tienda
                        </button>
                        <button onclick="tryAlternativeProduct()" 
                                style="padding: 10px 20px; background: #4a7c59; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Ver Productos Similares
                        </button>
                        <button onclick="retryLoadProduct()" 
                                style="padding: 10px 20px; background: #ff6b35; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Reintentar
                        </button>
                    </div>
                </div>
            `;
        }

        // Funci√≥n para intentar cargar un producto alternativo
        function tryAlternativeProduct() {
            console.log('üîÑ Buscando productos alternativos...');
            window.location.href = '/#productos';
        }

        // Funci√≥n para reintentar carga
        function retryLoadProduct() {
            console.log('üîÑ Reintentando carga del producto...');
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            
            hasLoaded = false;
            loadProduct();
        }

        // ============================================
        // FUNCIONES PRINCIPALES DE CARGA
        // ============================================

        // Funci√≥n principal para cargar producto
        async function loadProduct() {
            if (hasLoaded) {
                console.log('‚è≠Ô∏è Ya se carg√≥ el producto, saltando...');
                return;
            }
            
            const productId = getProductIdFromURL();
            
            if (!productId) {
                showError('ID de producto no v√°lido');
                return;
            }

            console.log(`üîç Buscando producto ID: ${productId}`);
            console.log('üìä Estado de Firebase:', {
                dbExists: !!window.db,
                firebaseExists: typeof firebase !== 'undefined',
                productId: productId
            });
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('product-content').style.display = 'none';
            document.getElementById('product-tabs').style.display = 'none';
            document.getElementById('related-products').style.display = 'none';

            try {
                hasLoaded = true;
                
                const firebaseConnected = await testFirebaseConnection();
                
                if (!firebaseConnected) {
                    console.warn('‚ö†Ô∏è Firebase no disponible, usando datos locales');
                    currentProduct = await loadProductFromLocal(productId);
                    if (currentProduct) {
                        displayProductDetails();
                        loadRelatedProducts();
                        return;
                    } else {
                        throw new Error('Producto no encontrado en datos locales');
                    }
                }
                
                console.log(`üì° Consultando Firestore para producto: ${productId}`);
                
                const productRef = window.db.collection('products').doc(productId);
                const productDoc = await productRef.get();
                
                console.log('üìÑ Resultado de la consulta:', {
                    exists: productDoc.exists,
                    id: productDoc.id,
                    data: productDoc.data()
                });
                
                if (productDoc.exists) {
                    const productData = productDoc.data();
                    console.log('‚úÖ Producto encontrado en Firestore:', productData.name);
                    
                    currentProduct = {
                        id: productDoc.id,
                        name: productData.name || 'Producto sin nombre',
                        brand: productData.brand || 'Marca no especificada',
                        description: productData.description || 'Sin descripci√≥n disponible',
                        price: Number(productData.price) || 0,
                        stock: Number(productData.stock) || 0,
                        rating: Number(productData.rating) || 0,
                        reviews: Number(productData.reviews) || 0,
                        category: productData.category || 'palas',
                        oldPrice: productData.oldPrice ? Number(productData.oldPrice) : null,
                        images: productData.images || (productData.image ? [productData.image] : []),
                        specifications: productData.specifications || {}
                    };
                    
                    console.log('üì¶ Producto procesado:', currentProduct);
                    
                    displayProductDetails();
                    loadRelatedProducts();
                    
                } else {
                    console.warn(`‚ö†Ô∏è Producto ${productId} no encontrado en Firestore`);
                    
                    currentProduct = await loadProductFromLocal(productId);
                    if (currentProduct) {
                        console.log('‚úÖ Producto encontrado en datos locales');
                        displayProductDetails();
                        loadRelatedProducts();
                    } else {
                        showErrorWithOptions(`El producto con ID "${productId}" no existe en nuestra base de datos.`);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando producto:', error);
                
                let errorMessage = 'Error cargando el producto. ';
                
                if (error.message.includes('permission') || error.code === 'permission-denied') {
                    errorMessage += 'Error de permisos. Verifica la configuraci√≥n de Firestore.';
                } else if (error.message.includes('network')) {
                    errorMessage += 'Error de red. Verifica tu conexi√≥n a internet.';
                } else if (error.message.includes('Producto no encontrado')) {
                    errorMessage = error.message;
                } else {
                    errorMessage += error.message;
                }
                
                showErrorWithOptions(errorMessage);
                
                hasLoaded = false;
            }
        }

        // Funci√≥n mejorada para cargar producto desde datos locales
        async function loadProductFromLocal(productId) {
            console.log(`üîç Buscando producto local ID: ${productId}`);
            
            // PRODUCTOS LOCALES CON TUS URLs REALES
            const localProducts = [
                {
                    id: '1',
                    name: 'Pala Bullpadel Vertex 03',
                    brand: 'Bullpadel',
                    description: 'La Pala Bullpadel Vertex 03 es una pala de potencia media-alta dise√±ada para jugadores intermedios que buscan mejorar su juego.',
                    price: 89990,
                    oldPrice: 99990,
                    stock: 15,
                    rating: 4.5,
                    reviews: 24,
                    category: 'palas',
                    images: [
                        'https://firebasestorage.googleapis.com/v0/b/padelfuego.appspot.com/o/palas%2Fbullpadel-vertex.jpg?alt=media'
                    ],
                    specifications: {
                        'Forma': 'Diamante',
                        'Peso': '360-375g',
                        'Balance': 'Alto',
                        'N√∫cleo': 'Goma EVA'
                    }
                },
                {
                    id: '2',
                    name: 'Pala Head Alpha Pro',
                    brand: 'Head',
                    description: 'La Pala Head Alpha Pro est√° dise√±ada para jugadores avanzados que buscan el m√°ximo control en la pista.',
                    price: 75990,
                    stock: 8,
                    rating: 4.3,
                    reviews: 18,
                    category: 'palas',
                    images: [
                        'https://firebasestorage.googleapis.com/v0/b/padelfuego.appspot.com/o/palas%2Fhead-alpha.jpg?alt=media'
                    ],
                    specifications: {
                        'Forma': 'Redonda',
                        'Peso': '355-370g',
                        'Balance': 'Bajo',
                        'N√∫cleo': 'Goma EVA High Density'
                    }
                }
            ];
            
            const product = localProducts.find(p => p.id === productId);
            
            if (!product) {
                console.log(`‚ö†Ô∏è Producto ${productId} no encontrado en locales, mostrando producto demo`);
                
                return {
                    id: productId,
                    name: `Producto ${productId.substring(0, 8)}`,
                    brand: 'P√°del Fuego',
                    description: 'Este es un producto de demostraci√≥n. Los detalles completos estar√°n disponibles pr√≥ximamente.',
                    price: 49990,
                    stock: 10,
                    rating: 4.0,
                    reviews: 0,
                    category: 'palas',
                    images: [],
                    specifications: {
                        'Estado': 'Disponible',
                        'Garant√≠a': '30 d√≠as',
                        'Env√≠o': '3-5 d√≠as h√°biles'
                    }
                };
            }
            
            return product;
        }

        // ============================================
        // FUNCIONES DE DISPLAY
        // ============================================

        // Mostrar detalles del producto
        function displayProductDetails() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('product-content').style.display = 'grid';
            document.getElementById('product-tabs').style.display = 'block';
            
            document.getElementById('current-product').textContent = currentProduct.name;
            document.getElementById('product-title').textContent = currentProduct.name;
            document.getElementById('product-brand').textContent = currentProduct.brand || 'Marca no especificada';
            
            document.getElementById('product-price').textContent = `$${currentProduct.price.toLocaleString('es-AR')}`;
            
            if (currentProduct.oldPrice) {
                document.getElementById('discount-container').style.display = 'block';
                document.getElementById('old-price').textContent = `$${currentProduct.oldPrice.toLocaleString('es-AR')}`;
                const discount = Math.round(((currentProduct.oldPrice - currentProduct.price) / currentProduct.oldPrice) * 100);
                document.getElementById('discount-badge').textContent = `${discount}% OFF`;
            }
            
            document.getElementById('rating-value').textContent = currentProduct.rating.toFixed(1);
            document.getElementById('reviews-count').textContent = `(${currentProduct.reviews || 0} rese√±as)`;
            
            const starsContainer = document.getElementById('rating-stars');
            starsContainer.innerHTML = getStarsHTML(currentProduct.rating);
            
            document.getElementById('short-description').textContent = 
                currentProduct.description.substring(0, 150) + (currentProduct.description.length > 150 ? '...' : '');
            
            document.getElementById('full-description').textContent = currentProduct.description;
            
            updateStockDisplay(currentProduct.stock);
            
            displayProductImages();
            
            displaySpecifications();
            
            setupQuantityControls();
            
            setupActionButtons();
            
            setupTabs();
        }

        // Generar HTML de estrellas
        function getStarsHTML(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            let starsHTML = '';
            
            for (let i = 0; i < 5; i++) {
                if (i < fullStars) {
                    starsHTML += '‚≠ê';
                } else if (i === fullStars && halfStar) {
                    starsHTML += '‚≠ê';
                } else {
                    starsHTML += '‚òÜ';
                }
            }
            
            return starsHTML;
        }

        // Actualizar display de stock
        function updateStockDisplay(stock) {
            const stockElement = document.getElementById('stock-status');
            const maxQuantityElement = document.getElementById('max-quantity');
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            
            maxQuantityElement.textContent = Math.min(stock, 10);
            
            if (stock > 10) {
                stockElement.textContent = 'En stock';
                stockElement.className = 'in-stock';
                addToCartBtn.disabled = false;
            } else if (stock > 0) {
                stockElement.textContent = `Solo ${stock} unidades disponibles`;
                stockElement.className = 'low-stock';
                addToCartBtn.disabled = false;
            } else {
                stockElement.textContent = 'Agotado';
                stockElement.className = 'out-of-stock';
                addToCartBtn.disabled = true;
                addToCartBtn.textContent = 'Producto Agotado';
            }
        }

        // Mostrar im√°genes del producto - SOLO URLs REALES
        function displayProductImages() {
            const mainImage = document.getElementById('main-product-image');
            const thumbnailsContainer = document.getElementById('thumbnail-images');
            
            let images = [];
            
            if (currentProduct.images && Array.isArray(currentProduct.images)) {
                images = currentProduct.images.filter(img => 
                    img && typeof img === 'string' && 
                    (img.startsWith('http://') || img.startsWith('https://'))
                );
            }
            
            if (currentProduct.image && typeof currentProduct.image === 'string' && 
                (currentProduct.image.startsWith('http://') || currentProduct.image.startsWith('https://'))) {
                if (!images.includes(currentProduct.image)) {
                    images.unshift(currentProduct.image);
                }
            }
            
            if (images.length === 0) {
                console.warn('‚ö†Ô∏è Producto sin im√°genes, usando placeholder simple');
                const productName = encodeURIComponent(currentProduct.name.substring(0, 20));
                const color = currentProduct.category === 'palas' ? '2c5530' : 
                             currentProduct.category === 'accesorios' ? '4a7c59' : 'ff6b35';
                
                const svgPlaceholder = `
                    <svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">
                        <rect width="100%" height="100%" fill="#${color}"/>
                        <text x="50%" y="50%" font-family="Arial" font-size="24" fill="white" 
                              text-anchor="middle" dy=".3em">${currentProduct.name}</text>
                    </svg>`;
                
                const svgDataUrl = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svgPlaceholder);
                images = [svgDataUrl];
            }
            
            currentImages = images;
            
            mainImage.src = images[0];
            mainImage.alt = currentProduct.name;
            mainImage.onclick = () => openImageZoom(images[0]);
            
            mainImage.onerror = function() {
                console.warn('‚ö†Ô∏è Error cargando imagen principal, usando fallback');
                this.onerror = null;
                const productName = encodeURIComponent(currentProduct.name.substring(0, 20));
                const color = currentProduct.category === 'palas' ? '2c5530' : 
                             currentProduct.category === 'accesorios' ? '4a7c59' : 'ff6b35';
                
                const svgPlaceholder = `
                    <svg width="600" height="400" xmlns="http://www.w3.org/2000/svg">
                        <rect width="100%" height="100%" fill="#${color}"/>
                        <text x="50%" y="50%" font-family="Arial" font-size="24" fill="white" 
                              text-anchor="middle" dy=".3em">${currentProduct.name}</text>
                    </svg>`;
                
                this.src = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svgPlaceholder);
            };
            
            thumbnailsContainer.innerHTML = '';
            
            if (images.length > 1) {
                images.forEach((image, index) => {
                    const thumbnail = document.createElement('img');
                    thumbnail.className = 'thumbnail' + (index === 0 ? ' active' : '');
                    thumbnail.src = image;
                    thumbnail.alt = `${currentProduct.name} - Vista ${index + 1}`;
                    thumbnail.onclick = () => switchMainImage(image, index);
                    
                    thumbnail.onerror = function() {
                        console.warn(`‚ö†Ô∏è Error cargando thumbnail ${index}`);
                        this.style.display = 'none';
                    };
                    
                    thumbnailsContainer.appendChild(thumbnail);
                });
            }
            
            console.log(`üñºÔ∏è ${images.length} im√°genes cargadas para el producto`);
        }

        // Cambiar imagen principal
        function switchMainImage(imageSrc, index) {
            const mainImage = document.getElementById('main-product-image');
            const thumbnails = document.querySelectorAll('.thumbnail');
            
            mainImage.src = imageSrc;
            
            thumbnails.forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
        }

        // Zoom de imagen
        function openImageZoom(imageSrc) {
            const overlay = document.getElementById('image-zoom-overlay');
            const zoomedImage = document.getElementById('zoomed-image');
            
            zoomedImage.src = imageSrc;
            overlay.style.display = 'flex';
        }

        // Cerrar zoom
        function closeImageZoom() {
            document.getElementById('image-zoom-overlay').style.display = 'none';
        }

        // Mostrar especificaciones
        function displaySpecifications() {
            const specsTable = document.getElementById('specs-table');
            specsTable.innerHTML = '';
            
            if (currentProduct.specifications && Object.keys(currentProduct.specifications).length > 0) {
                Object.entries(currentProduct.specifications).forEach(([key, value]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${key}</td>
                        <td>${value}</td>
                    `;
                    specsTable.appendChild(row);
                });
            } else {
                specsTable.innerHTML = `
                    <tr>
                        <td colspan="2" style="text-align: center; color: #666; padding: 30px;">
                            No hay especificaciones disponibles para este producto.
                        </td>
                    </tr>
                `;
            }
        }

        // Configurar controles de cantidad
        function setupQuantityControls() {
            const decreaseBtn = document.getElementById('decrease-qty');
            const increaseBtn = document.getElementById('increase-qty');
            const quantityInput = document.getElementById('quantity');
            const maxQuantity = Math.min(currentProduct.stock, 10);
            
            quantityInput.value = 1;
            quantityInput.max = maxQuantity;
            
            decreaseBtn.onclick = () => {
                const current = parseInt(quantityInput.value);
                if (current > 1) {
                    quantityInput.value = current - 1;
                    updateQuantityButtons();
                }
            };
            
            increaseBtn.onclick = () => {
                const current = parseInt(quantityInput.value);
                if (current < maxQuantity) {
                    quantityInput.value = current + 1;
                    updateQuantityButtons();
                }
            };
            
            quantityInput.onchange = () => {
                let value = parseInt(quantityInput.value);
                if (isNaN(value) || value < 1) value = 1;
                if (value > maxQuantity) value = maxQuantity;
                quantityInput.value = value;
                updateQuantityButtons();
            };
            
            function updateQuantityButtons() {
                const current = parseInt(quantityInput.value);
                decreaseBtn.disabled = current <= 1;
                increaseBtn.disabled = current >= maxQuantity;
            }
            
            updateQuantityButtons();
        }

        // Configurar botones de acci√≥n
        function setupActionButtons() {
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            const wishlistBtn = document.getElementById('wishlist-btn');
            
            addToCartBtn.onclick = () => {
                const quantity = parseInt(document.getElementById('quantity').value);
                addToCart(currentProduct.id, currentProduct.name, currentProduct.price, currentProduct.stock, quantity);
            };
            
            wishlistBtn.onclick = () => {
                addToWishlist();
            };
        }

        // ============================================
        // FUNCIONES DEL CARRITO (CORREGIDAS)
        // ============================================

        // Inicializar carrito
        function initCart() {
            console.log('üõí Inicializando carrito en product-details...');
            
            // Cargar carrito desde localStorage
            const savedCart = localStorage.getItem('padelCart');
            if (savedCart) {
                try {
                    cart = JSON.parse(savedCart);
                    console.log(`Carrito cargado: ${cart.length} productos`);
                } catch (e) {
                    console.warn('Error cargando carrito:', e);
                    cart = [];
                }
            } else {
                cart = [];
            }
            
            // Actualizar contador
            updateCartCounter();
        }

        // Funci√≥n para agregar al carrito (CORREGIDA)
        function addToCart(productId, productName, productPrice, productStock, quantity = 1) {
            try {
                console.log(`üõí Agregando ${quantity} ${productName} al carrito`);
                
                // Cargar carrito actual desde localStorage
                let cart = JSON.parse(localStorage.getItem('padelCart')) || [];
                
                const existingIndex = cart.findIndex(item => item.id === productId);
                
                if (existingIndex >= 0) {
                    // Si ya existe, aumentar cantidad
                    cart[existingIndex].quantity += quantity;
                    alert(`+${quantity} ${productName} (total: ${cart[existingIndex].quantity})`);
                } else {
                    // Si no existe, agregar nuevo
                    cart.push({
                        id: productId,
                        name: productName,
                        price: productPrice,
                        quantity: quantity,
                        maxStock: Math.min(productStock, 10)
                    });
                    alert(`‚úÖ ${productName} agregado al carrito`);
                }
                
                // Guardar carrito actualizado
                localStorage.setItem('padelCart', JSON.stringify(cart));
                
                // Actualizar variable global
                window.cart = cart;
                
                // Actualizar contador
                updateCartCounter();
                
                // Si el carrito est√° abierto, actualizar vista
                if (cartOpen) {
                    renderCart();
                }
                
            } catch (error) {
                console.error('Error agregando al carrito:', error);
                alert('‚ùå Error al agregar producto al carrito');
            }
        }

        // Funci√≥n para agregar a favoritos
        function addToWishlist() {
            try {
                let wishlist = JSON.parse(localStorage.getItem('padelWishlist')) || [];
                
                const alreadyExists = wishlist.some(item => item.id === currentProduct.id);
                
                if (alreadyExists) {
                    alert('‚ö†Ô∏è Este producto ya est√° en tus favoritos');
                } else {
                    wishlist.push({
                        id: currentProduct.id,
                        name: currentProduct.name,
                        price: currentProduct.price,
                        image: currentImages[0]
                    });
                    
                    localStorage.setItem('padelWishlist', JSON.stringify(wishlist));
                    alert('‚ù§Ô∏è Producto agregado a favoritos');
                }
            } catch (error) {
                console.error('Error agregando a favoritos:', error);
                alert('Error al agregar a favoritos');
            }
        }

        // Configurar pesta√±as
        function setupTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    
                    tabBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-content`) {
                            content.classList.add('active');
                        }
                    });
                });
            });
        }

        // Alternar carrito
        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            if (!modal) {
                console.error('‚ùå Modal del carrito no encontrado');
                return;
            }
            
            cartOpen = !cartOpen;
            if (cartOpen) {
                modal.style.display = 'flex';
                renderCart();
            } else {
                modal.style.display = 'none';
            }
        }

        // Renderizar carrito
        function renderCart() {
            const cartItems = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');
            const cartCounter = document.getElementById('cart-counter');
            
            if (!cartItems || !cartTotal) return;
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-cart">Tu carrito est√° vac√≠o</div>';
                cartTotal.textContent = '$0';
                if (cartCounter) {
                    cartCounter.textContent = '0';
                    cartCounter.style.display = 'none';
                }
                return;
            }
            
            let total = 0;
            let totalItems = 0;
            
            cartItems.innerHTML = '';
            cart.forEach((item, index) => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                totalItems += item.quantity;
                
                const itemHTML = `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <p class="cart-item-price">$${item.price.toLocaleString('es-AR')} c/u</p>
                        </div>
                        <div class="cart-item-controls">
                            <button onclick="updateCartItemQuantity(${index}, -1)" ${item.quantity <= 1 ? 'disabled style="opacity: 0.5;"' : ''}>‚àí</button>
                            <span class="cart-item-quantity">${item.quantity}</span>
                            <button onclick="updateCartItemQuantity(${index}, 1)">+</button>
                            <button class="remove-btn" onclick="removeCartItem(${index})">üóëÔ∏è</button>
                        </div>
                        <div class="cart-item-subtotal">
                            Subtotal: $${subtotal.toLocaleString('es-AR')}
                        </div>
                    </div>
                `;
                cartItems.insertAdjacentHTML('beforeend', itemHTML);
            });
            
            cartTotal.textContent = `$${total.toLocaleString('es-AR')}`;
            
            if (cartCounter) {
                cartCounter.textContent = totalItems.toString();
                cartCounter.style.display = totalItems > 0 ? 'inline-block' : 'none';
            }
            
            localStorage.setItem('padelCart', JSON.stringify(cart));
        }

        // Actualizar cantidad de item en carrito
        function updateCartItemQuantity(index, change) {
            if (!cart[index]) return;
            
            const newQuantity = cart[index].quantity + change;
            
            if (newQuantity < 1) {
                removeCartItem(index);
            } else {
                // Verificar stock m√°ximo
                if (cart[index].maxStock && newQuantity > cart[index].maxStock) {
                    alert(`M√°ximo disponible: ${cart[index].maxStock} unidades`);
                    return;
                }
                cart[index].quantity = newQuantity;
                renderCart();
            }
        }

        // Eliminar item del carrito
        function removeCartItem(index) {
            if (!cart[index]) return;
            
            const productName = cart[index].name;
            cart.splice(index, 1);
            renderCart();
            alert(`${productName} eliminado del carrito`);
        }

        // Vaciar carrito
        function clearCart() {
            if (cart.length === 0) {
                alert('El carrito ya est√° vac√≠o');
                return;
            }
            
            if (confirm('¬øEst√°s seguro de vaciar todo el carrito?')) {
                cart = [];
                renderCart();
                alert('Carrito vaciado');
            }
        }

        // Checkout
        function checkout() {
            if (cart.length === 0) {
                alert('Tu carrito est√° vac√≠o');
                return;
            }
            
            // Redirigir a checkout
            window.location.href = 'checkout.html';
        }

        // Actualizar contador del carrito
        function updateCartCounter() {
            const counter = document.getElementById('cart-counter');
            if (!counter) return;
            
            // Recalcular total de items
            const savedCart = JSON.parse(localStorage.getItem('padelCart') || '[]');
            const totalItems = savedCart.reduce((sum, item) => sum + item.quantity, 0);
            
            counter.textContent = totalItems.toString();
            counter.style.display = totalItems > 0 ? 'inline-block' : 'none';
            
            // Actualizar variable global
            cart = savedCart;
        }

        // ============================================
        // FUNCIONES DE PRODUCTOS RELACIONADOS
        // ============================================

        // Cargar productos relacionados
        async function loadRelatedProducts() {
            const relatedGrid = document.getElementById('related-grid');
            const relatedContainer = document.getElementById('related-products');
            
            try {
                relatedProducts = [];
                
                // Intentar cargar desde Firestore si est√° disponible
                if (window.db && currentProduct.category) {
                    try {
                        console.log(`üîç Buscando productos relacionados de categor√≠a: ${currentProduct.category}`);
                        const snapshot = await window.db.collection('products')
                            .where('category', '==', currentProduct.category)
                            .where('active', '==', true)
                            .limit(4)
                            .get();
                        
                        if (!snapshot.empty) {
                            relatedProducts = snapshot.docs
                                .filter(doc => doc.id !== currentProduct.id)
                                .map(doc => {
                                    const data = doc.data();
                                    return {
                                        id: doc.id,
                                        name: data.name || 'Producto sin nombre',
                                        price: Number(data.price) || 0,
                                        brand: data.brand || 'Marca no especificada',
                                        image: data.image || data.images?.[0] || '',
                                        rating: Number(data.rating) || 0,
                                        stock: Number(data.stock) || 0,
                                        category: data.category || 'palas'
                                    };
                                });
                            console.log(`‚úÖ ${relatedProducts.length} productos relacionados encontrados`);
                        }
                    } catch (firestoreError) {
                        console.error('Error cargando relacionados de Firestore:', firestoreError);
                    }
                }
                
                // Si no hay suficientes productos en Firestore, usar datos locales
                if (!relatedProducts.length || relatedProducts.length < 2) {
                    console.log('üîÑ Usando productos relacionados locales');
                    relatedProducts = await getLocalRelatedProducts();
                }
                
                // Si hay productos relacionados, mostrarlos
                if (relatedProducts.length > 0) {
                    relatedContainer.style.display = 'block';
                    displayRelatedProducts();
                } else {
                    console.log('‚ÑπÔ∏è No hay productos relacionados disponibles');
                    relatedContainer.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error cargando productos relacionados:', error);
                document.getElementById('related-products').style.display = 'none';
            }
        }

        // Obtener productos relacionados locales
        async function getLocalRelatedProducts() {
            try {
                console.log('üîç Buscando productos relacionados en datos locales...');
                
                // PRODUCTOS CON TUS URLs REALES
                const allLocalProducts = [
                    {
                        id: '1',
                        name: 'Pala Bullpadel Vertex 03',
                        price: 89990,
                        brand: 'Bullpadel',
                        category: 'palas',
                        image: 'https://firebasestorage.googleapis.com/v0/b/padelfuego.appspot.com/o/palas%2Fbullpadel-vertex.jpg?alt=media',
                        rating: 4.5,
                        stock: 15
                    },
                    {
                        id: '2',
                        name: 'Pala Head Alpha Pro',
                        price: 75990,
                        brand: 'Head',
                        category: 'palas',
                        image: 'https://firebasestorage.googleapis.com/v0/b/padelfuego.appspot.com/o/palas%2Fhead-alpha.jpg?alt=media',
                        rating: 4.3,
                        stock: 8
                    },
                    {
                        id: '3',
                        name: 'Pelotas Head Padel Pro',
                        price: 12990,
                        brand: 'Head',
                        category: 'accesorios',
                        image: 'https://firebasestorage.googleapis.com/v0/b/padelfuego.appspot.com/o/accesorios%2Fpelotas-head.jpg?alt=media',
                        rating: 4.7,
                        stock: 50
                    },
                    {
                        id: '4',
                        name: 'Mochila Bullpadel Advance',
                        price: 34990,
                        brand: 'Bullpadel',
                        category: 'accesorios',
                        image: 'https://firebasestorage.googleapis.com/v0/b/padelfuego.appspot.com/o/accesorios%2Fmochila-bullpadel.jpg?alt=media',
                        rating: 4.2,
                        stock: 12
                    },
                    {
                        id: '5',
                        name: 'Zapatos Asics Gel-Padel Pro',
                        price: 55990,
                        brand: 'Asics',
                        category: 'accesorios',
                        image: 'https://firebasestorage.googleapis.com/v0/b/padelfuego.appspot.com/o/accesorios%2Fzapatos-asics.jpg?alt=media',
                        rating: 4.6,
                        stock: 6
                    }
                ];
                
                // Filtrar por categor√≠a del producto actual
                let filteredProducts = allLocalProducts;
                if (currentProduct.category) {
                    filteredProducts = allLocalProducts.filter(p => 
                        p.category === currentProduct.category && p.id !== currentProduct.id
                    );
                }
                
                // Si no hay suficientes de la misma categor√≠a, mostrar otros productos
                if (filteredProducts.length < 2) {
                    filteredProducts = allLocalProducts
                        .filter(p => p.id !== currentProduct.id)
                        .slice(0, 3);
                }
                
                return filteredProducts.slice(0, 3);
                
            } catch (error) {
                console.error('Error obteniendo productos locales:', error);
                return [];
            }
        }

        // Mostrar productos relacionados
        function displayRelatedProducts() {
            const relatedGrid = document.getElementById('related-grid');
            relatedGrid.innerHTML = '';
            
            relatedProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.style.cursor = 'pointer';
                productCard.onclick = () => {
                    window.location.href = `product-details.html?id=${product.id}`;
                };
                
                // Funci√≥n para crear placeholder SVG
                function createSVGPlaceholder(productName, category) {
                    const color = category === 'palas' ? '2c5530' : 
                                 category === 'accesorios' ? '4a7c59' : 'ff6b35';
                    
                    const svg = `<svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
                        <rect width="100%" height="100%" fill="#${color}"/>
                        <text x="50%" y="50%" font-family="Arial" font-size="16" fill="white" 
                              text-anchor="middle" dy=".3em">${productName.substring(0, 30)}</text>
                    </svg>`;
                    
                    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
                }
                
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="${product.image || createSVGPlaceholder(product.name, product.category)}" 
                             alt="${product.name}" 
                             loading="lazy"
                             onerror="
                                 const placeholder = \`${createSVGPlaceholder(product.name, product.category)}\`;
                                 this.src = placeholder;
                             ">
                    </div>
                    <h3>${product.name}</h3>
                    <p class="brand">${product.brand}</p>
                    <div class="price">$${product.price.toLocaleString('es-AR')}</div>
                    <div class="rating">${getStarsHTML(product.rating || 0)} ${(product.rating || 0).toFixed(1)}/5</div>
                    <button class="add-to-cart" onclick="event.stopPropagation(); addToCart('${product.id}', '${product.name}', ${product.price}, ${product.stock || 10}, 1)">
                        Agregar al Carrito
                    </button>
                `;
                
                relatedGrid.appendChild(productCard);
            });
            
            console.log(`‚úÖ Mostrados ${relatedProducts.length} productos relacionados`);
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        // Funci√≥n principal de inicializaci√≥n
        function initializePage() {
            console.log('üöÄ Inicializando p√°gina de detalles del producto...');
            
            // Inicializar carrito PRIMERO
            initCart();
            
            const closeZoomBtn = document.getElementById('close-zoom');
            const zoomOverlay = document.getElementById('image-zoom-overlay');
            
            if (closeZoomBtn) closeZoomBtn.onclick = closeImageZoom;
            if (zoomOverlay) {
                zoomOverlay.onclick = (e) => {
                    if (e.target === zoomOverlay) closeImageZoom();
                };
            }
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (cartOpen) {
                        toggleCart();
                    } else {
                        closeImageZoom();
                    }
                }
            });
            
            // Cerrar carrito al hacer clic fuera
            document.addEventListener('click', (e) => {
                const modal = document.getElementById('cart-modal');
                if (modal && cartOpen && !modal.contains(e.target) && 
                    !e.target.closest('.cart-link')) {
                    toggleCart();
                }
            });
            
            const productId = getProductIdFromURL();
            if (!productId) {
                showErrorWithOptions('No se especific√≥ un producto v√°lido.');
                return;
            }
            
            console.log(`üéØ Producto a cargar: ${productId}`);
            
            if (window.db) {
                console.log('‚úÖ Firebase ya est√° disponible, cargando producto...');
                db = window.db;
                loadProduct();
            } else {
                console.log('‚è≥ Esperando a que Firebase est√© listo...');
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        // Inicializar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

        // Escuchar evento de Firebase listo
        document.addEventListener('firebaseReady', () => {
            console.log('üî• Evento firebaseReady recibido');
            
            if (window.db) {
                db = window.db;
                console.log('‚úÖ DB asignado desde evento');
                
                if (!hasLoaded && !currentProduct) {
                    console.log('üîÑ Firebase listo, cargando producto...');
                    loadProduct();
                }
            }
        });

        // ============================================
        // EXPORTAR FUNCIONES GLOBALES
        // ============================================
        window.addToCart = addToCart;
        window.switchMainImage = switchMainImage;
        window.openImageZoom = openImageZoom;
        window.closeImageZoom = closeImageZoom;
        window.tryAlternativeProduct = tryAlternativeProduct;
        window.retryLoadProduct = retryLoadProduct;
        window.loadProduct = loadProduct;
        window.toggleCart = toggleCart;
        window.updateCartItemQuantity = updateCartItemQuantity;
        window.removeCartItem = removeCartItem;
        window.clearCart = clearCart;
        window.checkout = checkout;
        window.updateCartCounter = updateCartCounter;

    </script>
</body>
</html>