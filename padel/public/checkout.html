<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - P√°del Fuego</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header */
        .checkout-header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .checkout-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .checkout-header .step-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step.active .step-number {
            background: white;
            color: #2c5530;
        }

        .step-text {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Main Content */
        .checkout-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .checkout-content {
                grid-template-columns: 1fr;
            }
        }

        /* Order Summary */
        .order-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            height: fit-content;
        }

        .order-summary h3 {
            color: #2c5530;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .order-items {
            margin-bottom: 20px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
        }

        .item-quantity {
            color: #666;
            font-size: 0.9rem;
        }

        .item-price {
            font-weight: 600;
        }

        .order-total {
            border-top: 2px solid #2c5530;
            padding-top: 15px;
            margin-top: 15px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .grand-total {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c5530;
        }

        /* Forms */
        .checkout-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .form-section h3 {
            color: #2c5530;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .required::after {
            content: " *";
            color: #ff4444;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2c5530;
            box-shadow: 0 0 0 3px rgba(44, 85, 48, 0.1);
        }

        /* Payment Methods */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-method:hover {
            border-color: #2c5530;
        }

        .payment-method.selected {
            border-color: #2c5530;
            background: #f0f7f0;
        }

        .payment-method input[type="radio"] {
            width: 20px;
            height: 20px;
        }

        .payment-icon {
            font-size: 24px;
        }

        /* Terms */
        .terms {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .terms input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .terms label {
            font-size: 0.9rem;
            font-weight: normal;
        }

        .terms a {
            color: #2c5530;
            text-decoration: none;
        }

        .terms a:hover {
            text-decoration: underline;
        }

        /* Buttons */
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-back {
            background: #6c757d;
            color: white;
        }

        .btn-back:hover {
            background: #5a6268;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
        }

        .btn-confirm:hover {
            background: linear-gradient(135deg, #1e3a23 0%, #2c5530 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 85, 48, 0.2);
        }

        .btn-confirm:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Stock Warning */
        .stock-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
            align-items: flex-start;
            gap: 10px;
        }

        .stock-warning.show {
            display: flex;
        }

        .warning-icon {
            font-size: 20px;
        }

        .warning-content {
            flex: 1;
        }

        .warning-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .warning-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .warning-btn.accept {
            background: #28a745;
            color: white;
        }

        .warning-btn.cancel {
            background: #dc3545;
            color: white;
        }

        /* Success Modal */
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .success-content {
            background: white;
            padding: 50px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            animation: modalIn 0.5s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-icon {
            font-size: 80px;
            color: #2c5530;
            margin-bottom: 20px;
        }

        .success-content h2 {
            color: #2c5530;
            margin-bottom: 15px;
        }

        .success-content p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .order-number {
            background: #f0f7f0;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            color: #2c5530;
            margin: 20px 0;
            display: inline-block;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #e0e0e0;
            border-top-color: #2c5530;
            border-radius: 50%;
            margin-left: 15px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .checkout-header h1 {
                font-size: 2rem;
            }
            
            .checkout-content {
                padding: 20px;
            }
            
            .form-section {
                padding: 20px;
            }
            
            .buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="checkout-container">
        <!-- Header -->
        <div class="checkout-header">
            <h1>üõí Finalizar Compra</h1>
            <p>Completa tus datos para completar el pedido</p>
            
            <div class="step-indicator">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-text">Datos</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-text">Pago</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-text">Confirmaci√≥n</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="checkout-content">
            <!-- Order Form -->
            <div class="checkout-form">
                <!-- Error Message -->
                <div id="error-message" class="error-message"></div>

                <!-- Stock Warning -->
                <div id="stock-warning" class="stock-warning">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-content">
                        <strong>Advertencia de stock</strong>
                        <p id="stock-warning-text">Algunos productos tienen stock insuficiente.</p>
                        <div class="warning-actions">
                            <button class="warning-btn accept" onclick="proceedWithLowStock()">
                                Proceder igual
                            </button>
                            <button class="warning-btn cancel" onclick="cancelLowStock()">
                                Cancelar compra
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Personal Info -->
                <div class="form-section">
                    <h3>üë§ Informaci√≥n Personal</h3>
                    <div class="form-group">
                        <label for="fullName" class="required">Nombre Completo</label>
                        <input type="text" id="fullName" placeholder="Juan P√©rez" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email" class="required">Email</label>
                            <input type="email" id="email" placeholder="juan@ejemplo.com" required>
                        </div>
                        <div class="form-group">
                            <label for="phone" class="required">Tel√©fono</label>
                            <input type="tel" id="phone" placeholder="+54 11 1234-5678" required>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="form-section">
                    <h3>üè† Direcci√≥n de Env√≠o</h3>
                    <div class="form-group">
                        <label for="address" class="required">Direcci√≥n</label>
                        <input type="text" id="address" placeholder="Calle Principal 123" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city" class="required">Ciudad</label>
                            <input type="text" id="city" placeholder="Buenos Aires" required>
                        </div>
                        <div class="form-group">
                            <label for="province" class="required">Provincia</label>
                            <select id="province" required>
                                <option value="">Seleccionar provincia</option>
                                <option value="CABA">Ciudad de Buenos Aires</option>
                                <option value="BA">Buenos Aires</option>
                                <option value="CBA">C√≥rdoba</option>
                                <option value="SF">Santa Fe</option>
                                <option value="MZA">Mendoza</option>
                                <option value="TDF">Tierra del Fuego</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="zipCode" class="required">C√≥digo Postal</label>
                            <input type="text" id="zipCode" placeholder="1234" required>
                        </div>
                        <div class="form-group">
                            <label for="country" class="required">Pa√≠s</label>
                            <select id="country" required>
                                <option value="AR" selected>Argentina</option>
                                <option value="UY">Uruguay</option>
                                <option value="CL">Chile</option>
                                <option value="PY">Paraguay</option>
                                <option value="BO">Bolivia</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="form-section">
                    <h3>üí≥ M√©todo de Pago</h3>
                    <div class="payment-methods">
                        <label class="payment-method" onclick="selectPaymentMethod('transferencia')">
                            <input type="radio" name="paymentMethod" value="transferencia">
                            <span class="payment-icon">üè¶</span>
                            <span>
                                <strong>Transferencia Bancaria</strong>
                                <small style="display: block; color: #666;">Recibir√°s los datos por email</small>
                            </span>
                        </label>
                        
                        <label class="payment-method" onclick="selectPaymentMethod('mercado-pago')">
                            <input type="radio" name="paymentMethod" value="mercado-pago">
                            <span class="payment-icon">üíô</span>
                            <span>
                                <strong>Mercado Pago</strong>
                                <small style="display: block; color: #666;">Pago seguro con tarjeta</small>
                            </span>
                        </label>
                        
                        <label class="payment-method" onclick="selectPaymentMethod('efectivo')">
                            <input type="radio" name="paymentMethod" value="efectivo">
                            <span class="payment-icon">üíµ</span>
                            <span>
                                <strong>Efectivo</strong>
                                <small style="display: block; color: #666;">Al momento de la entrega</small>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Additional Notes -->
                <div class="form-section">
                    <h3>üìù Notas Adicionales</h3>
                    <div class="form-group">
                        <label for="notes">Instrucciones especiales para la entrega</label>
                        <textarea id="notes" rows="3" placeholder="Ej: Llamar antes de entregar, entregar en porter√≠a, etc."></textarea>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="form-section">
                    <div class="terms">
                        <input type="checkbox" id="acceptTerms" required>
                        <label for="acceptTerms">
                            Acepto los <a href="#" onclick="showTerms()">t√©rminos y condiciones</a> y la 
                            <a href="#" onclick="showPrivacy()">pol√≠tica de privacidad</a>
                        </label>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="buttons">
                    <a href="/" class="btn btn-back">‚Üê Volver a la Tienda</a>
                    <button class="btn btn-confirm" onclick="submitOrder()" id="submitBtn">
                        <span>üí≥</span>
                        Confirmar Pedido
                    </button>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <h3>üìã Resumen del Pedido</h3>
                <div id="order-items" class="order-items">
                    <!-- Los productos se cargar√°n aqu√≠ -->
                </div>
                <div class="order-total">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <div class="total-row">
                        <span>Env√≠o:</span>
                        <span id="shipping">$2.500</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>Total:</span>
                        <span id="grand-total">$0</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <p style="color: #666; font-size: 0.9rem;">
                        <strong>üì¶ Env√≠o:</strong> 3-5 d√≠as h√°biles
                    </p>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                        <strong>üîÑ Devoluciones:</strong> 30 d√≠as de garant√≠a
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-icon">‚úÖ</div>
            <h2>¬°Pedido Confirmado!</h2>
            <p>Tu pedido ha sido procesado exitosamente. Hemos enviado un email de confirmaci√≥n con todos los detalles.</p>
            
            <div class="order-number">
                N¬∞ de Pedido: <span id="orderId">PF-00001</span>
            </div>
            
            <p style="font-size: 0.9rem;">
                Te contactaremos en las pr√≥ximas 24 horas para coordinar el env√≠o.
            </p>
            
            <div style="margin-top: 30px;">
                <a href="/" class="btn btn-confirm" style="width: 100%;">
                    ‚Üê Volver a la Tienda
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase Auth -->
    <script src="firebase-auth.js"></script>

    <script>
        // Cargar datos del carrito desde localStorage
        let cart = JSON.parse(localStorage.getItem('padelCart')) || [];
        let db = null;
        let proceedWithLowStock = false;
        
        // Inicializar Firebase
        function initFirebaseCheckout() {
            console.log('üî• Inicializando Firebase para checkout...');
            
            if (typeof firebase !== 'undefined' && window.initFirebase) {
                if (!window.db) {
                    window.initFirebase();
                }
                db = window.db;
                console.log('‚úÖ Firebase listo para checkout:', !!db);
            } else {
                console.warn('‚ö†Ô∏è Firebase no disponible para checkout');
                showError('Firebase no est√° disponible. Algunas funciones pueden no estar disponibles.');
            }
        }
        
        // Mostrar error
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            }
        }
        
        // Actualizar resumen del pedido
        function updateOrderSummary() {
            const orderItems = document.getElementById('order-items');
            const subtotalEl = document.getElementById('subtotal');
            const grandTotalEl = document.getElementById('grand-total');
            
            if (cart.length === 0) {
                orderItems.innerHTML = '<p style="color: #666; text-align: center;">No hay productos en el carrito</p>';
                subtotalEl.textContent = '$0';
                grandTotalEl.textContent = '$0';
                
                // Redirigir si el carrito est√° vac√≠o
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return;
            }
            
            let subtotal = 0;
            let html = '';
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                
                html += `
                    <div class="order-item">
                        <div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-quantity">${item.quantity} x $${item.price.toLocaleString('es-AR')}</div>
                        </div>
                        <div class="item-price">$${itemTotal.toLocaleString('es-AR')}</div>
                    </div>
                `;
            });
            
            orderItems.innerHTML = html;
            const shipping = 2500;
            const grandTotal = subtotal + shipping;
            
            subtotalEl.textContent = `$${subtotal.toLocaleString('es-AR')}`;
            grandTotalEl.textContent = `$${grandTotal.toLocaleString('es-AR')}`;
        }
        
        // Seleccionar m√©todo de pago
        function selectPaymentMethod(method) {
            // Remover clase selected de todos
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Agregar clase selected al seleccionado
            const selected = document.querySelector(`input[value="${method}"]`);
            if (selected) {
                selected.parentElement.classList.add('selected');
                selected.checked = true;
            }
        }
        
        // Mostrar t√©rminos
        function showTerms() {
            alert('T√âRMINOS Y CONDICIONES\n\n1. Todos los productos tienen 30 d√≠as de garant√≠a.\n2. Los env√≠os se realizan en 3-5 d√≠as h√°biles.\n3. Las devoluciones deben realizarse en el empaque original.\n4. Los precios incluyen IVA.\n5. El tiempo de entrega puede variar seg√∫n la ubicaci√≥n.');
            return false;
        }
        
        // Mostrar pol√≠tica de privacidad
        function showPrivacy() {
            alert('POL√çTICA DE PRIVACIDAD\n\n1. Tus datos personales solo se usar√°n para procesar tu pedido.\n2. No compartimos tu informaci√≥n con terceros.\n3. Puedes solicitar la eliminaci√≥n de tus datos en cualquier momento.\n4. Tus datos de pago son procesados de forma segura.\n5. Cumplimos con las leyes de protecci√≥n de datos.');
            return false;
        }
        
        // Generar n√∫mero de pedido √∫nico
        function generateOrderId() {
            const prefix = 'PF-';
            const timestamp = Date.now().toString().slice(-5);
            const randomNum = Math.floor(Math.random() * 900) + 100;
            return prefix + timestamp + randomNum;
        }
        
        // Verificar stock disponible
        async function checkStockAvailability(orderItems) {
            if (!db) {
                console.warn('‚ö†Ô∏è Firestore no disponible para verificar stock');
                return { available: true, outOfStockItems: [] };
            }
            
            try {
                const outOfStockItems = [];
                const lowStockItems = [];
                
                for (const item of orderItems) {
                    const productRef = db.collection('products').doc(item.id);
                    const productDoc = await productRef.get();
                    
                    if (productDoc.exists) {
                        const productData = productDoc.data();
                        const currentStock = Number(productData.stock) || 0;
                        
                        if (currentStock < item.quantity) {
                            outOfStockItems.push({
                                ...item,
                                availableStock: currentStock,
                                needed: item.quantity - currentStock
                            });
                        } else if (currentStock - item.quantity <= 3) {
                            lowStockItems.push({
                                ...item,
                                availableStock: currentStock,
                                remaining: currentStock - item.quantity
                            });
                        }
                    } else {
                        outOfStockItems.push({
                            ...item,
                            availableStock: 0,
                            needed: item.quantity,
                            error: 'Producto no encontrado'
                        });
                    }
                }
                
                return {
                    available: outOfStockItems.length === 0,
                    outOfStockItems,
                    lowStockItems,
                    hasLowStock: lowStockItems.length > 0
                };
                
            } catch (error) {
                console.error('Error verificando stock:', error);
                return { 
                    available: false, 
                    outOfStockItems: [], 
                    error: error.message 
                };
            }
        }
        
        // Mostrar advertencia de stock
        function showStockWarning(outOfStockItems, lowStockItems) {
            const warningEl = document.getElementById('stock-warning');
            const warningText = document.getElementById('stock-warning-text');
            
            let message = '';
            
            if (outOfStockItems.length > 0) {
                message += '<strong>Productos sin stock suficiente:</strong><br>';
                outOfStockItems.forEach(item => {
                    message += `‚Ä¢ ${item.name}: Pedido ${item.quantity}, Disponible ${item.availableStock}<br>`;
                });
            }
            
            if (lowStockItems.length > 0) {
                message += '<br><strong>Productos con stock bajo:</strong><br>';
                lowStockItems.forEach(item => {
                    message += `‚Ä¢ ${item.name}: Quedar√°n ${item.remaining} unidades<br>`;
                });
            }
            
            warningText.innerHTML = message;
            warningEl.classList.add('show');
            
            // Scroll a la advertencia
            warningEl.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Proceder con stock bajo
        function proceedWithLowStock() {
            proceedWithLowStock = true;
            document.getElementById('stock-warning').classList.remove('show');
            // Volver a intentar el submit
            submitOrder();
        }
        
        // Cancelar por stock bajo
        function cancelLowStock() {
            proceedWithLowStock = false;
            document.getElementById('stock-warning').classList.remove('show');
            showError('Por favor, ajusta las cantidades en tu carrito.');
        }
        
        // Actualizar stock de productos
        async function updateProductStock(orderItems, orderId) {
            if (!db) {
                console.warn('‚ö†Ô∏è Firestore no disponible para actualizar stock');
                return false;
            }
            
            try {
                console.log('üìâ Actualizando stock de productos...');
                
                // Usar batch para actualizar m√∫ltiples productos en una transacci√≥n
                const batch = db.batch();
                const stockUpdates = [];
                
                for (const item of orderItems) {
                    try {
                        const productRef = db.collection('products').doc(item.id);
                        const productDoc = await productRef.get();
                        
                        if (!productDoc.exists) {
                            console.warn(`‚ö†Ô∏è Producto ${item.id} no encontrado en Firestore`);
                            continue;
                        }
                        
                        const productData = productDoc.data();
                        const currentStock = Number(productData.stock) || 0;
                        const newStock = currentStock - item.quantity;
                        
                        // No permitir stock negativo
                        const updatedStock = Math.max(0, newStock);
                        
                        batch.update(productRef, {
                            stock: updatedStock,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastOrderId: orderId,
                            lastOrderDate: new Date().toISOString()
                        });
                        
                        stockUpdates.push({
                            productId: item.id,
                            productName: item.name,
                            previousStock: currentStock,
                            newStock: updatedStock,
                            quantity: item.quantity,
                            orderId: orderId,
                            timestamp: new Date().toISOString()
                        });
                        
                        console.log(`‚úÖ Stock actualizado: ${item.name} - ${currentStock} ‚Üí ${updatedStock}`);
                        
                    } catch (itemError) {
                        console.error(`‚ùå Error actualizando stock de ${item.name}:`, itemError);
                    }
                }
                
                // Guardar historial de cambios de stock
                if (stockUpdates.length > 0) {
                    const stockLogRef = db.collection('stockLogs').doc();
                    batch.set(stockLogRef, {
                        orderId: orderId,
                        updates: stockUpdates,
                        timestamp: new Date().toISOString(),
                        type: 'order_processed'
                    });
                }
                
                // Ejecutar todas las actualizaciones
                await batch.commit();
                console.log('‚úÖ Stock actualizado para todos los productos');
                return true;
                
            } catch (error) {
                console.error('‚ùå Error general actualizando stock:', error);
                throw error;
            }
        }
        
        // Guardar orden en Firestore
        async function saveOrderToFirestore(order) {
            try {
                if (!db) {
                    throw new Error('Firestore no disponible');
                }
                
                console.log('üíæ Guardando orden en Firestore...', order);
                
                // Agregar timestamp
                order.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                order.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                
                // Guardar en colecci√≥n 'orders'
                const docRef = await db.collection('orders').add(order);
                console.log('‚úÖ Orden guardada con ID:', docRef.id);
                
                // Actualizar el documento con su ID de Firestore
                await docRef.update({ firestoreId: docRef.id });
                
                // Actualizar stock de productos
                const stockUpdated = await updateProductStock(order.items, order.id);
                
                if (!stockUpdated) {
                    console.warn('‚ö†Ô∏è Stock no actualizado, pero orden guardada');
                }
                
                return {
                    success: true,
                    orderId: order.id,
                    firestoreId: docRef.id,
                    stockUpdated: stockUpdated
                };
                
            } catch (error) {
                console.error('‚ùå Error guardando en Firestore:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // Guardar orden en localStorage (fallback)
        function saveOrderToLocalStorage(order) {
            try {
                const orders = JSON.parse(localStorage.getItem('padelOrders') || '[]');
                orders.push(order);
                localStorage.setItem('padelOrders', JSON.stringify(orders));
                console.log('üíæ Orden guardada en localStorage');
                return { success: true };
            } catch (error) {
                console.error('Error guardando en localStorage:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Enviar pedido
        async function submitOrder() {
            // Validar formulario
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const city = document.getElementById('city').value.trim();
            const province = document.getElementById('province').value;
            const zipCode = document.getElementById('zipCode').value.trim();
            const country = document.getElementById('country').value;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
            const acceptTerms = document.getElementById('acceptTerms').checked;
            const notes = document.getElementById('notes').value.trim();
            
            // Validaciones
            if (!fullName || !email || !phone || !address || !city || !province || !zipCode || !country) {
                showError('Por favor, completa todos los campos obligatorios.');
                return;
            }
            
            if (!paymentMethod) {
                showError('Por favor, selecciona un m√©todo de pago.');
                return;
            }
            
            if (!acceptTerms) {
                showError('Debes aceptar los t√©rminos y condiciones para continuar.');
                return;
            }
            
            if (cart.length === 0) {
                showError('Tu carrito est√° vac√≠o. Agrega productos antes de confirmar.');
                return;
            }
            
            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('Por favor, ingresa un email v√°lido.');
                return;
            }
            
            // Mostrar loading
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span>Verificando stock...</span><div class="loading-spinner"></div>';
            submitBtn.disabled = true;
            
            try {
                // Verificar stock disponible
                const stockCheck = await checkStockAvailability(cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    quantity: item.quantity
                })));
                
                // Si hay productos sin stock
                if (!stockCheck.available && !proceedWithLowStock) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    showStockWarning(stockCheck.outOfStockItems, stockCheck.lowStockItems);
                    return;
                }
                
                // Si hay productos con stock bajo pero no cr√≠tico
                if (stockCheck.hasLowStock && !proceedWithLowStock) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    showStockWarning([], stockCheck.lowStockItems);
                    return;
                }
                
                // Actualizar loading
                submitBtn.innerHTML = '<span>Procesando pedido...</span><div class="loading-spinner"></div>';
                
                // Calcular totales
                const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const shipping = 2500;
                const total = subtotal + shipping;
                
                // Crear objeto del pedido
                const order = {
                    id: generateOrderId(), // N√∫mero de pedido √∫nico
                    customer: {
                        fullName,
                        email,
                        phone,
                        address,
                        city,
                        province,
                        zipCode,
                        country
                    },
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        subtotal: item.price * item.quantity
                    })),
                    totals: {
                        subtotal,
                        shipping,
                        total
                    },
                    paymentMethod: paymentMethod.value,
                    paymentStatus: 'pending', // pending, paid, failed
                    orderStatus: 'pending', // pending, processing, shipped, delivered, cancelled
                    notes: notes || '',
                    date: new Date().toISOString(),
                    status: 'pending',
                    source: 'web',
                    stockChecked: true,
                    stockCheckResult: stockCheck
                };
                
                console.log('üì¶ Creando orden:', order);
                
                // Intentar guardar en Firestore
                let saveResult;
                if (db) {
                    saveResult = await saveOrderToFirestore(order);
                } else {
                    saveResult = saveOrderToLocalStorage(order);
                }
                
                if (!saveResult.success) {
                    // Fallback a localStorage
                    console.log('üîÑ Usando fallback a localStorage');
                    saveResult = saveOrderToLocalStorage(order);
                }
                
                if (saveResult.success) {
                    // Limpiar carrito
                    localStorage.removeItem('padelCart');
                    cart = [];
                    
                    // Actualizar ID en el modal
                    document.getElementById('orderId').textContent = order.id;
                    
                    // Mostrar modal de √©xito
                    document.getElementById('successModal').style.display = 'flex';
                    
                    // Mostrar mensaje en consola (para desarrollo)
                    console.log('üéâ Orden creada exitosamente:', order);
                    console.log('üìß Enviar email a:', email);
                    console.log('üìû Contactar al:', phone);
                    console.log('üìâ Stock actualizado:', saveResult.stockUpdated);
                    
                } else {
                    throw new Error(saveResult.error || 'Error guardando la orden');
                }
                
            } catch (error) {
                console.error('‚ùå Error en submitOrder:', error);
                showError(`Error procesando el pedido: ${error.message}. Por favor, intenta nuevamente.`);
                
                // Restaurar bot√≥n
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Inicializando checkout...');
            
            // Inicializar Firebase
            initFirebaseCheckout();
            
            // Actualizar resumen
            updateOrderSummary();
            
            // Verificar si hay carrito vac√≠o
            if (cart.length === 0) {
                console.log('üõí Carrito vac√≠o, redirigiendo...');
                showError('Tu carrito est√° vac√≠o. Ser√°s redirigido a la tienda.');
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
            }
        });
        
        // Escuchar evento de Firebase listo
        document.addEventListener('firebaseReady', () => {
            console.log('üî• Firebase listo desde evento');
            db = window.db;
        });
    </script>
</body>
</html>