<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - P√°del Fuego</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .checkout-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Header */
        .checkout-header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .checkout-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .checkout-header .step-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step.active .step-number {
            background: white;
            color: #2c5530;
        }

        .step-text {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Main Content */
        .checkout-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .checkout-content {
                grid-template-columns: 1fr;
            }
        }

        /* Order Summary */
        .order-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            height: fit-content;
        }

        .order-summary h3 {
            color: #2c5530;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .order-items {
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .order-items::-webkit-scrollbar {
            width: 5px;
        }

        .order-items::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .order-items::-webkit-scrollbar-thumb {
            background: #2c5530;
            border-radius: 10px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
            font-size: 0.95rem;
        }

        .item-quantity {
            color: #666;
            font-size: 0.85rem;
        }

        .item-price {
            font-weight: 600;
            color: #2c5530;
        }

        .order-total {
            border-top: 2px solid #2c5530;
            padding-top: 15px;
            margin-top: 15px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 1.1rem;
        }

        .grand-total {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c5530;
        }

        /* Forms */
        .checkout-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .form-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .form-section h3 {
            color: #2c5530;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .required::after {
            content: " *";
            color: #ff4444;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2c5530;
            box-shadow: 0 0 0 3px rgba(44, 85, 48, 0.1);
        }

        /* Payment Methods */
        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .payment-method:hover {
            border-color: #2c5530;
            background: #f9f9f9;
        }

        .payment-method.selected {
            border-color: #2c5530;
            background: #f0f7f0;
        }

        .payment-method input[type="radio"] {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .payment-icon {
            font-size: 24px;
        }

        /* Terms */
        .terms {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .terms input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .terms label {
            font-size: 0.9rem;
            font-weight: normal;
            cursor: pointer;
        }

        .terms a {
            color: #2c5530;
            text-decoration: none;
            font-weight: 500;
        }

        .terms a:hover {
            text-decoration: underline;
        }

        /* Buttons */
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-back {
            background: #6c757d;
            color: white;
        }

        .btn-back:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-confirm {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
        }

        .btn-confirm:hover {
            background: linear-gradient(135deg, #1e3a23 0%, #2c5530 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 85, 48, 0.2);
        }

        .btn-confirm:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Stock Warning */
        .stock-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
            align-items: flex-start;
            gap: 10px;
        }

        .stock-warning.show {
            display: flex;
        }

        .warning-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .warning-content {
            flex: 1;
        }

        .warning-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .warning-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .warning-btn.accept {
            background: #28a745;
            color: white;
        }

        .warning-btn.accept:hover {
            background: #218838;
        }

        .warning-btn.cancel {
            background: #dc3545;
            color: white;
        }

        .warning-btn.cancel:hover {
            background: #c82333;
        }

        /* Success Modal */
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .success-content {
            background: white;
            padding: 50px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            animation: modalIn 0.5s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .success-icon {
            font-size: 80px;
            color: #2c5530;
            margin-bottom: 20px;
        }

        .success-content h2 {
            color: #2c5530;
            margin-bottom: 15px;
        }

        .success-content p {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .order-number {
            background: #f0f7f0;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            color: #2c5530;
            margin: 20px 0;
            display: inline-block;
            font-size: 1.2rem;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #e0e0e0;
            border-top-color: #2c5530;
            border-radius: 50%;
            margin-left: 15px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
            border: 1px solid #f5c6cb;
        }

        .error-message.show {
            display: block;
        }

        /* Empty Cart */
        .empty-cart-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-cart-message a {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: #2c5530;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .empty-cart-message a:hover {
            background: #1e3a23;
        }

        /* Cart Item Quantity Controls */
        .cart-item-quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .quantity-btn-small {
            width: 25px;
            height: 25px;
            border: 1px solid #2c5530;
            background: white;
            color: #2c5530;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn-small:hover {
            background: #2c5530;
            color: white;
        }

        .quantity-display {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="checkout-container">
        <!-- Header -->
        <div class="checkout-header">
            <h1>üõí Finalizar Compra</h1>
            <p>Completa tus datos para completar el pedido</p>
            
            <div class="step-indicator">
                <div class="step active">
                    <div class="step-number">1</div>
                    <div class="step-text">Datos</div>
                </div>
                <div class="step">
                    <div class="step-number">2</div>
                    <div class="step-text">Pago</div>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <div class="step-text">Confirmaci√≥n</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="checkout-content">
            <!-- Order Form -->
            <div class="checkout-form">
                <!-- Error Message -->
                <div id="error-message" class="error-message"></div>

                <!-- Stock Warning -->
                <div id="stock-warning" class="stock-warning">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-content">
                        <strong>Advertencia de stock</strong>
                        <p id="stock-warning-text">Algunos productos tienen stock insuficiente.</p>
                        <div class="warning-actions">
                            <button class="warning-btn accept" onclick="handleProceedWithLowStock()">
                                Proceder igual
                            </button>
                            <button class="warning-btn cancel" onclick="handleCancelLowStock()">
                                Cancelar compra
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Personal Info -->
                <div class="form-section">
                    <h3>üë§ Informaci√≥n Personal</h3>
                    <div class="form-group">
                        <label for="fullName" class="required">Nombre Completo</label>
                        <input type="text" id="fullName" placeholder="Juan P√©rez" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="email" class="required">Email</label>
                            <input type="email" id="email" placeholder="juan@ejemplo.com" required>
                        </div>
                        <div class="form-group">
                            <label for="phone" class="required">Tel√©fono</label>
                            <input type="tel" id="phone" placeholder="+54 11 1234-5678" required>
                        </div>
                    </div>
                </div>

                <!-- Shipping Address -->
                <div class="form-section">
                    <h3>üè† Direcci√≥n de Env√≠o</h3>
                    <div class="form-group">
                        <label for="address" class="required">Direcci√≥n</label>
                        <input type="text" id="address" placeholder="Calle Principal 123" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city" class="required">Ciudad</label>
                            <input type="text" id="city" placeholder="Buenos Aires" required>
                        </div>
                        <div class="form-group">
                            <label for="province" class="required">Provincia</label>
                            <select id="province" required>
                                <option value="">Seleccionar provincia</option>
                                <option value="CABA">Ciudad de Buenos Aires</option>
                                <option value="BA">Buenos Aires</option>
                                <option value="CBA">C√≥rdoba</option>
                                <option value="SF">Santa Fe</option>
                                <option value="MZA">Mendoza</option>
                                <option value="TDF">Tierra del Fuego</option>
                                <option value="ER">Entre R√≠os</option>
                                <option value="SJ">San Juan</option>
                                <option value="SL">San Luis</option>
                                <option value="RN">R√≠o Negro</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="zipCode" class="required">C√≥digo Postal</label>
                            <input type="text" id="zipCode" placeholder="1234" required>
                        </div>
                        <div class="form-group">
                            <label for="country" class="required">Pa√≠s</label>
                            <select id="country" required>
                                <option value="AR" selected>Argentina</option>
                                <option value="UY">Uruguay</option>
                                <option value="CL">Chile</option>
                                <option value="PY">Paraguay</option>
                                <option value="BO">Bolivia</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div class="form-section">
                    <h3>üí≥ M√©todo de Pago</h3>
                    <div class="payment-methods">
                        <label class="payment-method" onclick="selectPaymentMethod('transferencia')">
                            <input type="radio" name="paymentMethod" value="transferencia">
                            <span class="payment-icon">üè¶</span>
                            <span>
                                <strong>Transferencia Bancaria</strong>
                                <small style="display: block; color: #666;">Recibir√°s los datos por email</small>
                            </span>
                        </label>
                        
                        <label class="payment-method" onclick="selectPaymentMethod('mercado-pago')">
                            <input type="radio" name="paymentMethod" value="mercado-pago">
                            <span class="payment-icon">üíô</span>
                            <span>
                                <strong>Mercado Pago</strong>
                                <small style="display: block; color: #666;">Pago seguro con tarjeta</small>
                            </span>
                        </label>
                        
                        <label class="payment-method" onclick="selectPaymentMethod('efectivo')">
                            <input type="radio" name="paymentMethod" value="efectivo">
                            <span class="payment-icon">üíµ</span>
                            <span>
                                <strong>Efectivo</strong>
                                <small style="display: block; color: #666;">Al momento de la entrega</small>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Additional Notes -->
                <div class="form-section">
                    <h3>üìù Notas Adicionales</h3>
                    <div class="form-group">
                        <label for="notes">Instrucciones especiales para la entrega</label>
                        <textarea id="notes" rows="3" placeholder="Ej: Llamar antes de entregar, entregar en porter√≠a, etc."></textarea>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="form-section">
                    <div class="terms">
                        <input type="checkbox" id="acceptTerms" required>
                        <label for="acceptTerms">
                            Acepto los <a href="#" onclick="showTerms(); return false;">t√©rminos y condiciones</a> y la 
                            <a href="#" onclick="showPrivacy(); return false;">pol√≠tica de privacidad</a>
                        </label>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="buttons">
                    <a href="/" class="btn btn-back">‚Üê Volver a la Tienda</a>
                    <button class="btn btn-confirm" onclick="submitOrder()" id="submitBtn">
                        <span>üí≥</span>
                        Confirmar Pedido
                    </button>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <h3>üìã Resumen del Pedido</h3>
                <div id="order-items" class="order-items">
                    <!-- Los productos se cargar√°n aqu√≠ -->
                </div>
                <div id="empty-cart-message" class="empty-cart-message" style="display: none;">
                    <p>Tu carrito est√° vac√≠o</p>
                    <a href="/">Ver productos</a>
                </div>
                <div class="order-total">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0</span>
                    </div>
                    <div class="total-row">
                        <span>Env√≠o:</span>
                        <span id="shipping">$2.500</span>
                    </div>
                    <div class="total-row grand-total">
                        <span>Total:</span>
                        <span id="grand-total">$0</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <p style="color: #666; font-size: 0.9rem;">
                        <strong>üì¶ Env√≠o:</strong> 3-5 d√≠as h√°biles
                    </p>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                        <strong>üéÅ Env√≠o gratis en compras mayores a $50,000</strong>
                    </p>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                        <strong>üîÑ Devoluciones:</strong> 30 d√≠as de garant√≠a
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-icon">‚úÖ</div>
            <h2>¬°Pedido Confirmado!</h2>
            <p>Tu pedido ha sido procesado exitosamente. Hemos enviado un email de confirmaci√≥n con todos los detalles.</p>
            
            <div class="order-number">
                N¬∞ de Pedido: <span id="orderId">PF-00001</span>
            </div>
            
            <p style="font-size: 0.9rem;">
                Te contactaremos en las pr√≥ximas 24 horas para coordinar el env√≠o.
            </p>
            
            <div style="margin-top: 30px;">
                <a href="/" class="btn btn-confirm" style="width: 100%;">
                    ‚Üê Volver a la Tienda
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <script>
        // Variables globales
        let cart = [];
        let db = null;
        let isProcessingOrder = false;
        let proceedWithLowStockFlag = false;

        // ============================================
        // FUNCIONES DE INICIALIZACI√ìN
        // ============================================

        // Inicializar Firebase
        function initFirebaseCheckout() {
            console.log('üî• Inicializando Firebase para checkout...');
            
            if (typeof firebase !== 'undefined' && window.initFirebase) {
                if (!window.db) {
                    window.initFirebase();
                }
                db = window.db;
                console.log('‚úÖ Firebase listo para checkout:', !!db);
            } else {
                console.warn('‚ö†Ô∏è Firebase no disponible para checkout');
            }
        }

        // Validar y reparar datos del carrito
        function validateAndRepairCart() {
            console.log('üîç Validando carrito...');
            
            try {
                const cartData = localStorage.getItem('padelCart');
                
                if (!cartData || cartData === 'undefined' || cartData === 'null') {
                    console.warn('‚ùå Carrito no encontrado o inv√°lido');
                    cart = [];
                    return false;
                }
                
                cart = JSON.parse(cartData);
                
                if (!Array.isArray(cart)) {
                    console.error('‚ùå Carrito no es un array');
                    cart = [];
                    return false;
                }
                
                console.log(`‚úÖ Carrito validado: ${cart.length} productos`);
                return true;
                
            } catch (error) {
                console.error('‚ùå Error validando carrito:', error);
                cart = [];
                return false;
            }
        }

        // Mostrar/ocultar mensaje de error
        function showError(message, duration = 5000) {
            const errorEl = document.getElementById('error-message');
            if (!errorEl) return;
            
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, duration);
        }

        // Mostrar/ocultar mensaje de carrito vac√≠o
        function toggleEmptyCartMessage(show) {
            const emptyMsg = document.getElementById('empty-cart-message');
            const orderItems = document.getElementById('order-items');
            const orderTotal = document.querySelector('.order-total');
            
            if (emptyMsg && orderItems && orderTotal) {
                emptyMsg.style.display = show ? 'block' : 'none';
                orderItems.style.display = show ? 'none' : 'block';
                orderTotal.style.display = show ? 'none' : 'block';
            }
        }

        // ============================================
        // FUNCIONES DE CALCULO Y DISPLAY
        // ============================================

        // Actualizar resumen del pedido
        function updateOrderSummary() {
            console.log('üìä Actualizando resumen del pedido...');
            
            const orderItems = document.getElementById('order-items');
            const subtotalEl = document.getElementById('subtotal');
            const shippingEl = document.getElementById('shipping');
            const grandTotalEl = document.getElementById('grand-total');
            
            if (!cart || cart.length === 0) {
                console.log('üõí Carrito vac√≠o');
                orderItems.innerHTML = '';
                subtotalEl.textContent = '$0';
                shippingEl.textContent = '$0';
                grandTotalEl.textContent = '$0';
                toggleEmptyCartMessage(true);
                return;
            }
            
            toggleEmptyCartMessage(false);
            
            let subtotal = 0;
            let html = '';
            
            cart.forEach(item => {
                const price = Number(item.price) || 0;
                const quantity = Number(item.quantity) || 1;
                const itemTotal = price * quantity;
                
                subtotal += itemTotal;
                
                html += `
                    <div class="order-item">
                        <div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-quantity">${quantity} x $${price.toLocaleString('es-AR')}</div>
                            <div class="cart-item-quantity-controls">
                                <button class="quantity-btn-small" onclick="updateCartQuantity('${item.id}', -1)">-</button>
                                <span class="quantity-display">${quantity}</span>
                                <button class="quantity-btn-small" onclick="updateCartQuantity('${item.id}', 1)">+</button>
                                <button class="quantity-btn-small" onclick="removeFromCheckoutCart('${item.id}')" style="margin-left: 10px; background: #ff4444; color: white; border-color: #ff4444;">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="item-price">$${itemTotal.toLocaleString('es-AR')}</div>
                    </div>
                `;
            });
            
            orderItems.innerHTML = html;
            
            const shipping = subtotal >= 50000 ? 0 : 2500;
            const grandTotal = subtotal + shipping;
            
            subtotalEl.textContent = `$${subtotal.toLocaleString('es-AR')}`;
            shippingEl.textContent = shipping === 0 ? 'GRATIS' : `$${shipping.toLocaleString('es-AR')}`;
            shippingEl.style.color = shipping === 0 ? '#2c5530' : '#333';
            shippingEl.style.fontWeight = shipping === 0 ? 'bold' : 'normal';
            grandTotalEl.textContent = `$${grandTotal.toLocaleString('es-AR')}`;
        }

        // Actualizar cantidad en el carrito
        function updateCartQuantity(productId, change) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex === -1) return;
            
            const newQuantity = cart[itemIndex].quantity + change;
            
            if (newQuantity < 1) {
                cart.splice(itemIndex, 1);
            } else {
                if (cart[itemIndex].maxStock && newQuantity > cart[itemIndex].maxStock) {
                    showError(`M√°ximo disponible: ${cart[itemIndex].maxStock} unidades`);
                    return;
                }
                cart[itemIndex].quantity = newQuantity;
            }
            
            localStorage.setItem('padelCart', JSON.stringify(cart));
            updateOrderSummary();
        }

        // Eliminar producto del carrito
        function removeFromCheckoutCart(productId) {
            if (!confirm('¬øEliminar este producto del carrito?')) return;
            
            cart = cart.filter(item => item.id !== productId);
            localStorage.setItem('padelCart', JSON.stringify(cart));
            updateOrderSummary();
            showError('Producto eliminado del carrito', 3000);
        }

        // ============================================
        // FUNCIONES DE FORMULARIO
        // ============================================

        // Seleccionar m√©todo de pago
        function selectPaymentMethod(method) {
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            const selected = document.querySelector(`input[value="${method}"]`);
            if (selected) {
                selected.parentElement.classList.add('selected');
                selected.checked = true;
            }
        }

        // Mostrar t√©rminos
        function showTerms() {
            alert('T√âRMINOS Y CONDICIONES\n\n1. Todos los productos tienen 30 d√≠as de garant√≠a.\n2. Los env√≠os se realizan en 3-5 d√≠as h√°biles.\n3. Las devoluciones deben realizarse en el empaque original.\n4. Los precios incluyen IVA.\n5. El tiempo de entrega puede variar seg√∫n la ubicaci√≥n.');
        }

        // Mostrar pol√≠tica de privacidad
        function showPrivacy() {
            alert('POL√çTICA DE PRIVACIDAD\n\n1. Tus datos personales solo se usar√°n para procesar tu pedido.\n2. No compartimos tu informaci√≥n con terceros.\n3. Puedes solicitar la eliminaci√≥n de tus datos en cualquier momento.\n4. Tus datos de pago son procesados de forma segura.\n5. Cumplimos con las leyes de protecci√≥n de datos.');
        }

        // ============================================
        // FUNCIONES DE STOCK
        // ============================================

        // Funci√≥n para proceder con stock bajo
        function handleProceedWithLowStock() {
            proceedWithLowStockFlag = true;
            document.getElementById('stock-warning').classList.remove('show');
            submitOrder();
        }

        // Cancelar por stock bajo
        function handleCancelLowStock() {
            proceedWithLowStockFlag = false;
            document.getElementById('stock-warning').classList.remove('show');
            showError('Por favor, ajusta las cantidades en tu carrito.');
        }

        // Mostrar advertencia de stock
        function showStockWarning(outOfStockItems) {
            const warningEl = document.getElementById('stock-warning');
            const warningText = document.getElementById('stock-warning-text');
            
            let message = 'Los siguientes productos tienen stock insuficiente:\n\n';
            outOfStockItems.forEach(item => {
                message += `‚Ä¢ ${item.name}: Pedido ${item.quantity}, Disponible ${item.availableStock}\n`;
            });
            
            warningText.textContent = message;
            warningEl.classList.add('show');
            warningEl.scrollIntoView({ behavior: 'smooth' });
        }

        // Verificar stock disponible
        async function checkStockAvailability() {
            if (!db || cart.length === 0) {
                return { available: true, outOfStockItems: [] };
            }
            
            try {
                const outOfStockItems = [];
                
                for (const item of cart) {
                    try {
                        const productRef = db.collection('products').doc(item.id);
                        const productDoc = await productRef.get();
                        
                        if (productDoc.exists) {
                            const productData = productDoc.data();
                            const currentStock = Number(productData.stock) || 0;
                            
                            if (currentStock < item.quantity) {
                                outOfStockItems.push({
                                    ...item,
                                    availableStock: currentStock,
                                    needed: item.quantity - currentStock
                                });
                            }
                        } else {
                            outOfStockItems.push({
                                ...item,
                                availableStock: 0,
                                needed: item.quantity,
                                error: 'Producto no encontrado'
                            });
                        }
                    } catch (error) {
                        console.error(`Error verificando stock de ${item.name}:`, error);
                    }
                }
                
                return {
                    available: outOfStockItems.length === 0,
                    outOfStockItems
                };
                
            } catch (error) {
                console.error('Error verificando stock:', error);
                return { 
                    available: false, 
                    outOfStockItems: [], 
                    error: error.message 
                };
            }
        }

        // ============================================
        // FUNCIONES DE PEDIDO
        // ============================================

        // Generar n√∫mero de pedido √∫nico
        function generateOrderId() {
            const prefix = 'PF-';
            const timestamp = Date.now().toString().slice(-6);
            const randomNum = Math.floor(Math.random() * 900) + 100;
            return prefix + timestamp + randomNum;
        }

        // Validar formulario
        function validateForm() {
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const city = document.getElementById('city').value.trim();
            const province = document.getElementById('province').value;
            const zipCode = document.getElementById('zipCode').value.trim();
            const country = document.getElementById('country').value;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
            const acceptTerms = document.getElementById('acceptTerms').checked;
            
            if (!fullName) return 'Por favor, ingresa tu nombre completo';
            if (!email) return 'Por favor, ingresa tu email';
            if (!phone) return 'Por favor, ingresa tu tel√©fono';
            if (!address) return 'Por favor, ingresa tu direcci√≥n';
            if (!city) return 'Por favor, ingresa tu ciudad';
            if (!province) return 'Por favor, selecciona tu provincia';
            if (!zipCode) return 'Por favor, ingresa tu c√≥digo postal';
            if (!country) return 'Por favor, selecciona tu pa√≠s';
            if (!paymentMethod) return 'Por favor, selecciona un m√©todo de pago';
            if (!acceptTerms) return 'Debes aceptar los t√©rminos y condiciones';
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return 'Por favor, ingresa un email v√°lido';
            }
            
            return null;
        }

        // Enviar pedido
        async function submitOrder() {
            if (isProcessingOrder) {
                showError('Ya se est√° procesando tu pedido');
                return;
            }
            
            if (!cart || cart.length === 0) {
                showError('Tu carrito est√° vac√≠o');
                return;
            }
            
            const formError = validateForm();
            if (formError) {
                showError(formError);
                return;
            }
            
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const city = document.getElementById('city').value.trim();
            const province = document.getElementById('province').value;
            const zipCode = document.getElementById('zipCode').value.trim();
            const country = document.getElementById('country').value;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const notes = document.getElementById('notes').value.trim();
            
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += (item.price || 0) * (item.quantity || 1);
            });
            
            const shipping = subtotal >= 50000 ? 0 : 2500;
            const total = subtotal + shipping;
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span>Verificando stock...</span><div class="loading-spinner"></div>';
            submitBtn.disabled = true;
            isProcessingOrder = true;
            
            try {
                if (!proceedWithLowStockFlag && db) {
                    const stockCheck = await checkStockAvailability();
                    
                    if (!stockCheck.available) {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        isProcessingOrder = false;
                        showStockWarning(stockCheck.outOfStockItems);
                        return;
                    }
                }
                
                submitBtn.innerHTML = '<span>Procesando pedido...</span><div class="loading-spinner"></div>';
                
                const order = {
                    id: generateOrderId(),
                    customer: {
                        fullName,
                        email,
                        phone,
                        address,
                        city,
                        province,
                        zipCode,
                        country
                    },
                    items: cart.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        subtotal: item.price * item.quantity
                    })),
                    totals: {
                        subtotal,
                        shipping,
                        total
                    },
                    paymentMethod,
                    paymentStatus: 'pending',
                    orderStatus: 'pending',
                    notes: notes || '',
                    date: new Date().toISOString(),
                    source: 'web'
                };
                
                console.log('üì¶ Creando orden:', order);
                
                let saveResult;
                if (db) {
                    try {
                        order.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        order.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        
                        const docRef = await db.collection('orders').add(order);
                        saveResult = {
                            success: true,
                            orderId: order.id,
                            firestoreId: docRef.id
                        };
                    } catch (firestoreError) {
                        console.error('Error en Firestore:', firestoreError);
                        saveResult = saveOrderToLocalStorage(order);
                    }
                } else {
                    saveResult = saveOrderToLocalStorage(order);
                }
                
                if (saveResult && saveResult.success) {
                    localStorage.removeItem('padelCart');
                    cart = [];
                    
                    document.getElementById('orderId').textContent = order.id;
                    document.getElementById('successModal').style.display = 'flex';
                    
                    console.log('üéâ Orden creada exitosamente:', order);
                    
                } else {
                    throw new Error(saveResult?.error || 'Error guardando la orden');
                }
                
            } catch (error) {
                console.error('‚ùå Error en submitOrder:', error);
                showError(`Error procesando el pedido: ${error.message}. Por favor, intenta nuevamente.`);
                
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                isProcessingOrder = false;
                return;
            }
        }

        // Guardar orden en localStorage (fallback)
        function saveOrderToLocalStorage(order) {
            try {
                const orders = JSON.parse(localStorage.getItem('padelOrders') || '[]');
                orders.push(order);
                localStorage.setItem('padelOrders', JSON.stringify(orders));
                return { success: true };
            } catch (error) {
                console.error('Error guardando en localStorage:', error);
                return { success: false, error: error.message };
            }
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Inicializando checkout...');
            
            initFirebaseCheckout();
            validateAndRepairCart();
            updateOrderSummary();
            
            document.addEventListener('firebaseReady', () => {
                db = window.db;
                console.log('‚úÖ Firebase listo desde evento');
            });
            
            if (cart.length === 0) {
                console.log('üõí Carrito vac√≠o al cargar la p√°gina');
                showError('Tu carrito est√° vac√≠o. Ser√°s redirigido a la tienda en 5 segundos.', 5000);
                setTimeout(() => {
                    window.location.href = '/';
                }, 5000);
            }
        });

        // ============================================
        // EXPORTAR FUNCIONES GLOBALES
        // ============================================

        window.updateCartQuantity = updateCartQuantity;
        window.removeFromCheckoutCart = removeFromCheckoutCart;
        window.selectPaymentMethod = selectPaymentMethod;
        window.showTerms = showTerms;
        window.showPrivacy = showPrivacy;
        window.handleProceedWithLowStock = handleProceedWithLowStock;
        window.handleCancelLowStock = handleCancelLowStock;
        window.submitOrder = submitOrder;
    </script>
</body>
</html>