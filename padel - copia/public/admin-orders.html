<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√ìrdenes - Panel Admin - P√°del Fuego</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .admin-header {
            background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn-primary {
            background: white;
            color: #2c5530;
        }

        .btn-primary:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            border-left: 5px solid #2c5530;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c5530;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
        }

        .filter-group select, .filter-group input {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            min-width: 180px;
        }

        /* Orders Table */
        .orders-table-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .orders-table th {
            background: #f8f9fa;
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        .orders-table td {
            padding: 18px 15px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            min-width: 100px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #cce5ff;
            color: #004085;
        }

        .status-shipped {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-delivered {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        /* Customer Info */
        .customer-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .customer-name {
            font-weight: 600;
            color: #333;
        }

        .customer-email {
            color: #666;
            font-size: 0.9rem;
        }

        /* Actions */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .btn-view:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-edit:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-cancel {
            background: #ff9800;
            color: white;
        }

        .btn-cancel:hover {
            background: #e68900;
            transform: translateY(-2px);
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Order Details Modal */
        .order-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .order-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.4s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            border-bottom: 2px solid #e0e0e0;
            background: #2c5530;
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-section {
            margin-bottom: 30px;
        }

        .modal-section h3 {
            color: #2c5530;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .customer-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .detail-item {
            margin-bottom: 10px;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .detail-value {
            color: #666;
        }

        .order-items-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .order-items-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .order-items-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.1rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #e0e0e0;
            border-top-color: #2c5530;
            border-radius: 50%;
            margin-left: 15px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Stock Restoration Modal */
        .stock-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10001;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .stock-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            padding: 30px;
            animation: modalIn 0.4s ease;
        }

        .stock-option {
            margin: 15px 0;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .stock-option:hover {
            border-color: #2c5530;
            background: #f0f7f0;
        }

        .stock-option.selected {
            border-color: #2c5530;
            background: #f0f7f0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .header-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group select, .filter-group input {
                width: 100%;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .customer-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="admin-header">
            <h1>üìã √ìrdenes de Compra</h1>
            <div class="header-actions">
                <a href="/admin-with-auth.html" class="btn btn-secondary">
                    ‚Üê Panel Principal
                </a>
                <a href="/" class="btn btn-primary" target="_blank">
                    üåê Ver Tienda
                </a>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-orders">0</div>
                <div class="stat-label">Total √ìrdenes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pending-orders">0</div>
                <div class="stat-label">Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="processing-orders">0</div>
                <div class="stat-label">En Proceso</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-revenue">$0</div>
                <div class="stat-label">Ingresos Totales</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label for="filter-status">Estado</label>
                <select id="filter-status" onchange="filterOrders()">
                    <option value="">Todos los estados</option>
                    <option value="pending">Pendiente</option>
                    <option value="processing">En proceso</option>
                    <option value="shipped">Enviado</option>
                    <option value="delivered">Entregado</option>
                    <option value="cancelled">Cancelado</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="filter-date">Fecha</label>
                <select id="filter-date" onchange="filterOrders()">
                    <option value="">Todas las fechas</option>
                    <option value="today">Hoy</option>
                    <option value="week">Esta semana</option>
                    <option value="month">Este mes</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="search-order">Buscar</label>
                <input type="text" id="search-order" placeholder="N¬∞ orden o cliente" onkeyup="filterOrders()">
            </div>
            
            <div class="filter-group" style="margin-left: auto;">
                <button class="btn btn-primary" onclick="loadOrders()" style="margin-top: 20px;">
                    üîÑ Actualizar
                </button>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="orders-table-container">
            <div id="orders-container">
                <div class="loading">
                    Cargando √≥rdenes...
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="order-modal" id="orderModal">
        <div class="order-modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">üìÑ Detalles del Pedido</h2>
                <button class="close-modal" onclick="closeModal()">√ó</button>
            </div>
            
            <div class="modal-body">
                <div id="modalContent">
                    <!-- Contenido din√°mico -->
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">
                    Cerrar
                </button>
                <button class="btn btn-primary" id="printBtn" onclick="printOrder()">
                    üñ®Ô∏è Imprimir
                </button>
            </div>
        </div>
    </div>

    <!-- Stock Restoration Modal -->
    <div class="stock-modal" id="stockModal">
        <div class="stock-modal-content">
            <h3 style="color: #2c5530; margin-bottom: 20px;">üîÑ Restaurar Stock</h3>
            <p style="margin-bottom: 20px;">¬øQu√© deseas hacer con el stock de los productos de esta orden?</p>
            
            <div class="stock-option" onclick="selectStockOption('restore')" id="option-restore">
                <strong>‚úÖ Restaurar todo el stock</strong>
                <p style="margin-top: 5px; color: #666; font-size: 0.9rem;">
                    Se sumar√° la cantidad comprada al stock actual de cada producto.
                </p>
            </div>
            
            <div class="stock-option" onclick="selectStockOption('partial')" id="option-partial">
                <strong>‚ö†Ô∏è Restaurar stock parcialmente</strong>
                <p style="margin-top: 5px; color: #666; font-size: 0.9rem;">
                    Podr√°s elegir qu√© productos restaurar y en qu√© cantidad.
                </p>
            </div>
            
            <div class="stock-option" onclick="selectStockOption('none')" id="option-none">
                <strong>‚ùå No restaurar stock</strong>
                <p style="margin-top: 5px; color: #666; font-size: 0.9rem;">
                    El stock permanecer√° como est√°. Solo se cancelar√° la orden.
                </p>
            </div>
            
            <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeStockModal()">
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="confirmStockRestoration()" id="confirmStockBtn">
                    Continuar
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Auth -->
    <script src="firebase-auth.js"></script>

    <script>
        // Variables globales
        let db = null;
        let allOrders = [];
        let currentOrder = null;
        let selectedStockOption = 'restore';
        let orderToCancel = null;
        
        // Inicializar Firebase
        function initFirebaseAdmin() {
            console.log('üî• Inicializando Firebase para admin...');
            
            if (typeof firebase !== 'undefined' && window.initFirebase) {
                if (!window.db) {
                    window.initFirebase();
                }
                db = window.db;
                console.log('‚úÖ Firebase listo para admin:', !!db);
                loadOrders();
            } else {
                console.error('‚ùå Firebase no disponible');
                document.getElementById('orders-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Error de conexi√≥n</h3>
                        <p>Firebase no est√° disponible. Verifica tu conexi√≥n.</p>
                    </div>
                `;
            }
        }
        
        // Cargar √≥rdenes desde Firestore
        async function loadOrders() {
            try {
                if (!db) {
                    throw new Error('Firestore no disponible');
                }
                
                const ordersContainer = document.getElementById('orders-container');
                ordersContainer.innerHTML = '<div class="loading">Cargando √≥rdenes...<div class="loading-spinner"></div></div>';
                
                console.log('üìã Cargando √≥rdenes desde Firestore...');
                
                // Obtener √≥rdenes ordenadas por fecha descendente
                const snapshot = await db.collection('orders')
                    .orderBy('date', 'desc')
                    .get();
                
                if (snapshot.empty) {
                    ordersContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h3>No hay √≥rdenes</h3>
                            <p>No se encontraron √≥rdenes de compra.</p>
                        </div>
                    `;
                    allOrders = [];
                    updateStats([]);
                    return;
                }
                
                allOrders = [];
                snapshot.forEach(doc => {
                    const order = doc.data();
                    order.firestoreId = doc.id; // Agregar ID de Firestore
                    allOrders.push(order);
                });
                
                console.log(`‚úÖ ${allOrders.length} √≥rdenes cargadas`);
                
                // Actualizar estad√≠sticas
                updateStats(allOrders);
                
                // Renderizar √≥rdenes
                renderOrders(allOrders);
                
            } catch (error) {
                console.error('‚ùå Error cargando √≥rdenes:', error);
                document.getElementById('orders-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Error al cargar √≥rdenes</h3>
                        <p>${error.message}</p>
                        <button onclick="loadOrders()" class="btn btn-primary" style="margin-top: 20px;">
                            üîÑ Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        // Actualizar estad√≠sticas
        function updateStats(orders) {
            const total = orders.length;
            const pending = orders.filter(o => o.orderStatus === 'pending').length;
            const processing = orders.filter(o => o.orderStatus === 'processing').length;
            const revenue = orders.reduce((sum, order) => sum + (order.totals?.total || 0), 0);
            
            document.getElementById('total-orders').textContent = total;
            document.getElementById('pending-orders').textContent = pending;
            document.getElementById('processing-orders').textContent = processing;
            document.getElementById('total-revenue').textContent = `$${revenue.toLocaleString('es-AR')}`;
        }
        
        // Renderizar √≥rdenes en tabla
        function renderOrders(orders) {
            if (orders.length === 0) {
                document.getElementById('orders-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h3>No hay resultados</h3>
                        <p>No se encontraron √≥rdenes con los filtros aplicados.</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>N¬∞ Orden</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Pago</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            orders.forEach(order => {
                const orderDate = new Date(order.date);
                const formattedDate = orderDate.toLocaleDateString('es-AR');
                const formattedTime = orderDate.toLocaleTimeString('es-AR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                html += `
                    <tr>
                        <td>
                            <strong>${order.id}</strong>
                        </td>
                        <td>
                            <div class="customer-info">
                                <div class="customer-name">${order.customer.fullName}</div>
                                <div class="customer-email">${order.customer.email}</div>
                            </div>
                        </td>
                        <td>
                            ${formattedDate}<br>
                            <small style="color: #666;">${formattedTime}</small>
                        </td>
                        <td>
                            <strong style="color: #2c5530;">
                                $${order.totals?.total?.toLocaleString('es-AR') || '0'}
                            </strong>
                        </td>
                        <td>
                            <span class="status-badge status-${order.orderStatus || 'pending'}">
                                ${getStatusText(order.orderStatus)}
                            </span>
                        </td>
                        <td>
                            <span style="color: #666;">
                                ${getPaymentMethodText(order.paymentMethod)}<br>
                                <small>${order.paymentStatus || 'pending'}</small>
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn btn-view" onclick="viewOrder('${order.firestoreId}')" title="Ver detalles">
                                    üëÅÔ∏è
                                </button>
                                <button class="action-btn btn-edit" onclick="editOrder('${order.firestoreId}')" title="Editar estado">
                                    ‚úèÔ∏è
                                </button>
                                <button class="action-btn btn-cancel" onclick="cancelOrder('${order.firestoreId}')" title="Cancelar y restaurar stock">
                                    ‚Ü©Ô∏è
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteOrder('${order.firestoreId}', false)" title="Eliminar">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('orders-container').innerHTML = html;
        }
        
        // Filtrar √≥rdenes
        function filterOrders() {
            const statusFilter = document.getElementById('filter-status').value;
            const dateFilter = document.getElementById('filter-date').value;
            const searchFilter = document.getElementById('search-order').value.toLowerCase();
            
            let filteredOrders = [...allOrders];
            
            // Filtrar por estado
            if (statusFilter) {
                filteredOrders = filteredOrders.filter(order => 
                    order.orderStatus === statusFilter
                );
            }
            
            // Filtrar por fecha
            if (dateFilter) {
                const now = new Date();
                filteredOrders = filteredOrders.filter(order => {
                    const orderDate = new Date(order.date);
                    
                    switch (dateFilter) {
                        case 'today':
                            return orderDate.toDateString() === now.toDateString();
                        case 'week':
                            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                            return orderDate >= weekAgo;
                        case 'month':
                            const monthAgo = new Date(now);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            return orderDate >= monthAgo;
                        default:
                            return true;
                    }
                });
            }
            
            // Filtrar por b√∫squeda
            if (searchFilter) {
                filteredOrders = filteredOrders.filter(order => 
                    order.id.toLowerCase().includes(searchFilter) ||
                    order.customer.fullName.toLowerCase().includes(searchFilter) ||
                    order.customer.email.toLowerCase().includes(searchFilter)
                );
            }
            
            renderOrders(filteredOrders);
        }
        
        // Ver detalles de orden
        async function viewOrder(firestoreId) {
            try {
                if (!db) throw new Error('Firestore no disponible');
                
                const doc = await db.collection('orders').doc(firestoreId).get();
                if (!doc.exists) {
                    alert('Orden no encontrada');
                    return;
                }
                
                currentOrder = doc.data();
                currentOrder.firestoreId = firestoreId;
                
                // Construir contenido del modal
                let content = `
                    <div class="modal-section">
                        <h3>üìã Informaci√≥n del Pedido</h3>
                        <div class="customer-details">
                            <div class="detail-item">
                                <div class="detail-label">N¬∞ de Pedido</div>
                                <div class="detail-value">${currentOrder.id}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Fecha</div>
                                <div class="detail-value">${new Date(currentOrder.date).toLocaleString('es-AR')}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Estado</div>
                                <div class="detail-value">
                                    <span class="status-badge status-${currentOrder.orderStatus || 'pending'}">
                                        ${getStatusText(currentOrder.orderStatus)}
                                    </span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">M√©todo de Pago</div>
                                <div class="detail-value">${getPaymentMethodText(currentOrder.paymentMethod)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <h3>üë§ Informaci√≥n del Cliente</h3>
                        <div class="customer-details">
                            <div class="detail-item">
                                <div class="detail-label">Nombre</div>
                                <div class="detail-value">${currentOrder.customer.fullName}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Email</div>
                                <div class="detail-value">${currentOrder.customer.email}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Tel√©fono</div>
                                <div class="detail-value">${currentOrder.customer.phone}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Direcci√≥n</div>
                                <div class="detail-value">
                                    ${currentOrder.customer.address}<br>
                                    ${currentOrder.customer.city}, ${currentOrder.customer.province}<br>
                                    ${currentOrder.customer.zipCode}, ${currentOrder.customer.country}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <h3>üõí Productos</h3>
                        <table class="order-items-table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                currentOrder.items.forEach(item => {
                    content += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>$${item.price.toLocaleString('es-AR')}</td>
                            <td>$${(item.price * item.quantity).toLocaleString('es-AR')}</td>
                        </tr>
                    `;
                });
                
                content += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="modal-section">
                        <h3>üí∞ Resumen de Pagos</h3>
                        <div class="customer-details">
                            <div class="detail-item">
                                <div class="detail-label">Subtotal</div>
                                <div class="detail-value">$${currentOrder.totals?.subtotal?.toLocaleString('es-AR') || '0'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Env√≠o</div>
                                <div class="detail-value">$${currentOrder.totals?.shipping?.toLocaleString('es-AR') || '0'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total</div>
                                <div class="detail-value" style="font-size: 1.2rem; font-weight: bold; color: #2c5530;">
                                    $${currentOrder.totals?.total?.toLocaleString('es-AR') || '0'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${currentOrder.notes ? `
                    <div class="modal-section">
                        <h3>üìù Notas Adicionales</h3>
                        <div class="detail-item">
                            <div class="detail-value" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                ${currentOrder.notes}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                `;
                
                document.getElementById('modalContent').innerHTML = content;
                document.getElementById('modalTitle').innerHTML = `üìÑ Pedido ${currentOrder.id}`;
                document.getElementById('orderModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error viendo orden:', error);
                alert('Error cargando los detalles de la orden');
            }
        }
        
        // Editar estado de orden
        async function editOrder(firestoreId) {
            try {
                // Obtener orden actual
                const orderDoc = await db.collection('orders').doc(firestoreId).get();
                const currentOrderData = orderDoc.data();
                
                const newStatus = prompt(
                    'Nuevo estado:\n' +
                    'pending: Pendiente\n' +
                    'processing: En proceso\n' +
                    'shipped: Enviado\n' +
                    'delivered: Entregado\n' +
                    'cancelled: Cancelado\n\n' +
                    'Ingresa el nuevo estado:',
                    currentOrderData.orderStatus || 'processing'
                );
                
                if (!newStatus || !['pending', 'processing', 'shipped', 'delivered', 'cancelled'].includes(newStatus)) {
                    alert('Estado inv√°lido');
                    return;
                }
                
                if (!db) throw new Error('Firestore no disponible');
                
                // Si se cancela una orden (de cualquier estado a 'cancelled')
                if (newStatus === 'cancelled' && currentOrderData.orderStatus !== 'cancelled') {
                    orderToCancel = {
                        id: firestoreId,
                        ...currentOrderData
                    };
                    showStockModal();
                    return;
                }
                
                // Si se re-activa una orden cancelada
                if (currentOrderData.orderStatus === 'cancelled' && newStatus !== 'cancelled') {
                    if (confirm('¬øRe-activar esta orden? El stock ya fue restaurado anteriormente.')) {
                        // Aqu√≠ podr√≠as restar el stock nuevamente si es necesario
                    }
                }
                
                // Actualizar estado
                await db.collection('orders').doc(firestoreId).update({
                    orderStatus: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`‚úÖ Estado actualizado a: ${getStatusText(newStatus)}`);
                loadOrders();
                
            } catch (error) {
                console.error('Error editando orden:', error);
                alert('Error actualizando el estado de la orden');
            }
        }
        
        // Cancelar orden (mostrar modal de stock)
        async function cancelOrder(firestoreId) {
            try {
                if (!db) throw new Error('Firestore no disponible');
                
                const orderDoc = await db.collection('orders').doc(firestoreId).get();
                if (!orderDoc.exists) {
                    alert('Orden no encontrada');
                    return;
                }
                
                orderToCancel = {
                    id: firestoreId,
                    ...orderDoc.data()
                };
                
                showStockModal();
                
            } catch (error) {
                console.error('Error obteniendo orden para cancelar:', error);
                alert('Error cargando la orden');
            }
        }
        
        // Eliminar orden permanentemente
        async function deleteOrder(firestoreId, restoreStock = false) {
            let confirmMessage = '¬øEst√°s seguro de eliminar esta orden permanentemente?\nEsta acci√≥n no se puede deshacer.';
            
            if (restoreStock) {
                confirmMessage = '¬øEliminar esta orden y restaurar el stock?';
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                if (!db) throw new Error('Firestore no disponible');
                
                // Obtener la orden antes de eliminarla
                const orderDoc = await db.collection('orders').doc(firestoreId).get();
                if (!orderDoc.exists) {
                    alert('Orden no encontrada');
                    return;
                }
                
                const order = orderDoc.data();
                
                // Si se debe restaurar stock
                if (restoreStock && (order.orderStatus === 'pending' || order.orderStatus === 'processing')) {
                    await restoreProductStock(order.items);
                }
                
                // Eliminar la orden
                await db.collection('orders').doc(firestoreId).delete();
                
                alert(restoreStock ? '‚úÖ Orden eliminada y stock restaurado' : '‚úÖ Orden eliminada');
                loadOrders();
                
            } catch (error) {
                console.error('Error eliminando orden:', error);
                alert('Error eliminando la orden');
            }
        }
        
        // Mostrar modal de restauraci√≥n de stock
        function showStockModal() {
            document.getElementById('stockModal').style.display = 'flex';
            selectedStockOption = 'restore';
            selectStockOption('restore');
        }
        
        // Cerrar modal de stock
        function closeStockModal() {
            document.getElementById('stockModal').style.display = 'none';
            orderToCancel = null;
        }
        
        // Seleccionar opci√≥n de stock
        function selectStockOption(option) {
            selectedStockOption = option;
            
            // Remover selecci√≥n de todas las opciones
            document.querySelectorAll('.stock-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            // Agregar selecci√≥n a la opci√≥n elegida
            document.getElementById(`option-${option}`).classList.add('selected');
        }
        
        // Confirmar restauraci√≥n de stock
        async function confirmStockRestoration() {
            if (!orderToCancel) {
                closeStockModal();
                return;
            }
            
            try {
                // Actualizar estado de la orden a cancelado
                await db.collection('orders').doc(orderToCancel.id).update({
                    orderStatus: 'cancelled',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    cancelledAt: new Date().toISOString(),
                    cancellationReason: 'Cancelado por administrador'
                });
                
                // Restaurar stock seg√∫n la opci√≥n seleccionada
                switch (selectedStockOption) {
                    case 'restore':
                        await restoreProductStock(orderToCancel.items);
                        alert('‚úÖ Orden cancelada y stock restaurado completamente');
                        break;
                    case 'partial':
                        // Aqu√≠ podr√≠as implementar una interfaz para restaurar parcialmente
                        await restoreProductStock(orderToCancel.items);
                        alert('‚úÖ Orden cancelada y stock restaurado');
                        break;
                    case 'none':
                        alert('‚úÖ Orden cancelada (stock no restaurado)');
                        break;
                }
                
                closeStockModal();
                loadOrders();
                
            } catch (error) {
                console.error('Error cancelando orden:', error);
                alert('Error cancelando la orden');
                closeStockModal();
            }
        }
        
        // Restaurar stock de productos
        async function restoreProductStock(orderItems) {
            if (!db) {
                console.warn('‚ö†Ô∏è Firestore no disponible para restaurar stock');
                return;
            }
            
            try {
                console.log('üîÑ Restaurando stock de productos...');
                
                // Usar batch para actualizar m√∫ltiples productos en una transacci√≥n
                const batch = db.batch();
                const stockRestorations = [];
                
                for (const item of orderItems) {
                    try {
                        const productRef = db.collection('products').doc(item.id);
                        const productDoc = await productRef.get();
                        
                        if (!productDoc.exists) {
                            console.warn(`‚ö†Ô∏è Producto ${item.id} no encontrado`);
                            continue;
                        }
                        
                        const productData = productDoc.data();
                        const currentStock = Number(productData.stock) || 0;
                        const restoredStock = currentStock + item.quantity;
                        
                        batch.update(productRef, {
                            stock: restoredStock,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastRestoration: new Date().toISOString(),
                            lastCancelledOrder: orderToCancel?.id
                        });
                        
                        stockRestorations.push({
                            productId: item.id,
                            productName: item.name,
                            previousStock: currentStock,
                            newStock: restoredStock,
                            quantity: item.quantity,
                            orderId: orderToCancel?.id,
                            timestamp: new Date().toISOString()
                        });
                        
                        console.log(`‚úÖ Stock restaurado: ${item.name} - ${currentStock} ‚Üí ${restoredStock}`);
                        
                    } catch (itemError) {
                        console.error(`‚ùå Error restaurando stock de ${item.name}:`, itemError);
                    }
                }
                
                // Guardar historial de restauraciones
                if (stockRestorations.length > 0) {
                    const restorationLogRef = db.collection('stockLogs').doc();
                    batch.set(restorationLogRef, {
                        orderId: orderToCancel?.id,
                        restorations: stockRestorations,
                        timestamp: new Date().toISOString(),
                        type: 'order_cancelled',
                        option: selectedStockOption
                    });
                }
                
                // Ejecutar todas las actualizaciones
                await batch.commit();
                console.log('‚úÖ Stock restaurado para todos los productos');
                
            } catch (error) {
                console.error('‚ùå Error general restaurando stock:', error);
                throw error;
            }
        }
        
        // Cerrar modal
        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        // Imprimir orden
        function printOrder() {
            if (!currentOrder) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Orden ${currentOrder.id} - P√°del Fuego</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #2c5530; }
                        .section { margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background: #f5f5f5; }
                        .total { font-size: 1.2rem; font-weight: bold; color: #2c5530; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>üõí P√°del Fuego - Orden ${currentOrder.id}</h1>
                    <div class="section">
                        <h3>üìã Informaci√≥n del Pedido</h3>
                        <p><strong>Fecha:</strong> ${new Date(currentOrder.date).toLocaleString('es-AR')}</p>
                        <p><strong>Estado:</strong> ${getStatusText(currentOrder.orderStatus)}</p>
                        <p><strong>M√©todo de Pago:</strong> ${getPaymentMethodText(currentOrder.paymentMethod)}</p>
                    </div>
                    
                    <div class="section">
                        <h3>üë§ Informaci√≥n del Cliente</h3>
                        <p><strong>Nombre:</strong> ${currentOrder.customer.fullName}</p>
                        <p><strong>Email:</strong> ${currentOrder.customer.email}</p>
                        <p><strong>Tel√©fono:</strong> ${currentOrder.customer.phone}</p>
                        <p><strong>Direcci√≥n:</strong> ${currentOrder.customer.address}, ${currentOrder.customer.city}, ${currentOrder.customer.province}, ${currentOrder.customer.zipCode}, ${currentOrder.customer.country}</p>
                    </div>
                    
                    <div class="section">
                        <h3>üõí Productos</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
            `);
            
            currentOrder.items.forEach(item => {
                printWindow.document.write(`
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>$${item.price.toLocaleString('es-AR')}</td>
                        <td>$${(item.price * item.quantity).toLocaleString('es-AR')}</td>
                    </tr>
                `);
            });
            
            printWindow.document.write(`
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="section">
                        <h3>üí∞ Resumen de Pagos</h3>
                        <p><strong>Subtotal:</strong> $${currentOrder.totals?.subtotal?.toLocaleString('es-AR') || '0'}</p>
                        <p><strong>Env√≠o:</strong> $${currentOrder.totals?.shipping?.toLocaleString('es-AR') || '0'}</p>
                        <p class="total"><strong>Total:</strong> $${currentOrder.totals?.total?.toLocaleString('es-AR') || '0'}</p>
                    </div>
                    
                    ${currentOrder.notes ? `
                    <div class="section">
                        <h3>üìù Notas Adicionales</h3>
                        <p>${currentOrder.notes}</p>
                    </div>
                    ` : ''}
                    
                    <div class="section no-print">
                        <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
                        <button onclick="window.close()">‚ùå Cerrar</button>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }
        
        // Helper functions
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pendiente',
                'processing': 'En proceso',
                'shipped': 'Enviado',
                'delivered': 'Entregado',
                'cancelled': 'Cancelado'
            };
            return statusMap[status] || 'Pendiente';
        }
        
        function getPaymentMethodText(method) {
            const methodMap = {
                'transferencia': 'Transferencia Bancaria',
                'mercado-pago': 'Mercado Pago',
                'efectivo': 'Efectivo'
            };
            return methodMap[method] || method || 'No especificado';
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Inicializando admin de √≥rdenes...');
            initFirebaseAdmin();
        });
        
        // Escuchar evento de Firebase listo
        document.addEventListener('firebaseReady', () => {
            console.log('üî• Firebase listo desde evento');
            db = window.db;
            loadOrders();
        });
    </script>
</body>
</html>